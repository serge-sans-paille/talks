<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Un an de nettoyage du syst&#xE8;me de build de Firefox</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><img src="jack.jpg" width="1000px"></img></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="un-an-de-nettoyage-du-systeme-de-build-de-firefox">Un an de nettoyage du syst&#xE8;me de build de Firefox</h1><p><strong>Serge &#xAB; sans paille &#xBB; Guelton</strong></p><p>Ing&#xE9;nieur en Compil' / Conteur / Employ&#xE9; Mozilla</p><p><strong>Federez &#x2014; 17 Mai 2025</strong></p></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><img src="AncestralRecall_2048x2048.jpg" width="1000px"></img></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="plongeon-dans-le-passe">Plongeon dans le pass&#xE9;</h1><ul><li><strong>31 mars 1998</strong> : Lib&#xE9;ration du code source de Netscape</li></ul><pre class="highlight code sh">$<span class="w"> </span>curl<span class="w"> </span>/ftp.mozilla.org/pub/mozilla/source/mozilla-19980331-unix.tar.gz<span class="w">
</span>$<span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>mozilla-19980331-unix.tar.gz<span class="w">
</span>$<span class="w"> </span>ls<span class="w"> </span>ns<span class="w">
</span>...<span class="w"> </span>Makefile<span class="w"> </span>...<span class="w"> </span>README<span class="w"> </span>...<span class="w"> </span>unxbuild.txt<span class="w"> </span>...<span class="w"> </span>build/</pre><p>Ni <tt>./configure</tt>, ni <tt>autoconf</tt>.</p><p><tt>build/</tt> contient un r&#xE9;pertoire <tt>CVS</tt> <tt>:-)</tt></p></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="avec-un-autre-outil">Avec un autre outil</h1><pre class="highlight code sh">$<span class="w"> </span>git<span class="w"> </span>tag<span class="w">
</span>...<span class="w"> </span>FIREFOX_RELEASE_30_END<span class="w"> </span>..<span class="w">
</span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>FIREFOX_RELEASE_30_END<span class="w">
</span>$<span class="w"> </span>ls<span class="w">
</span>...<span class="w"> </span>mach<span class="w"> </span>...<span class="w"> </span>Makefile.in<span class="w"> </span>...<span class="w"> </span>build/moz.configure</pre><p>c'est bien trop r&#xE9;cent !</p></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><pre class="highlight code sh">$<span class="w"> </span>git<span class="w"> </span>log<span class="w"> </span>mach<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w">
</span>commit<span class="w"> </span>0f8e4c10e371883b55c99bb82a69fad301ce6e1f<span class="w">
</span>Author:<span class="w"> </span>Gregory<span class="w"> </span>Szorc<span class="w"> </span>&lt;gps@mozilla.com&gt;<span class="w">
</span>Date:<span class="w">   </span>Wed<span class="w"> </span>Sep<span class="w"> </span><span class="m">26</span><span class="w"> </span><span class="m">09</span>:43:54<span class="w"> </span><span class="m">2012</span><span class="w"> </span>-0700<span class="w">

    </span>Bug<span class="w"> </span><span class="m">751795</span><span class="w"> </span>-<span class="w"> </span>Part<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>mach,<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>frontend<span class="w"> </span>to<span class="w">
      </span>mozilla-central<span class="p">;</span><span class="w"> </span><span class="nv">r</span><span class="o">=</span>jhammel</pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><pre class="highlight code sh">$<span class="w"> </span>git<span class="w"> </span>ls-tree<span class="w"> </span>0f8e4c10e371883b55c99bb82a69fad301ce6e1f<span class="w">
</span>...<span class="w"> </span>aclocal.m4<span class="w"> </span>...<span class="w"> </span>allmakefiles.sh<span class="w"> </span>...<span class="w"> </span>configure.in</pre></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="fin-de-l-enquete">Fin de l'enqu&#xE8;te</h1><ol><li>Un syst&#xE8;me bas&#xE9; uniquement sur Make</li><li>Autoconf + Make</li><li>Syst&#xE8;me hybride ( autoconf | moz.configure ) + Make</li><li>Le pr&#xE9;sent</li></ol></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="chestertons-fence">Chesterton&#x2019;s Fence</h1><blockquote><p>Do not remove a fence</p><p>until you know</p><p>why it was put up</p><p>in the first place.</p></blockquote></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="supprimons-autoconf">Supprimons Autoconf ?</h1><ul><li>Autoconf est un super outil dans un monde centr&#xE9; sur *nix</li><li>Mozilla doit &#xEA;tre (cross-)compil&#xE9; vers :<blockquote><p>OSX, Android, Linux, Windows</p><p>x</p><p>arm32 aarch64 x86 x86_64</p></blockquote></li></ul></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="pourquoi-changer">Pourquoi changer ?</h1><ul><li>Faire plus propre n'est pas toujours suffisant !</li><li>Trouver d'autres m&#xE9;triques d'am&#xE9;liorations</li></ul></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="bug-1247781">Bug 1247781</h1><p>(9 years ago)</p><p>Our configure script is slow and hard to maintain. We'd like to convert it to a
Python script</p><p>(3 days ago)</p><p>Wait, there's no configure script anymore. It's time to close this bug.</p></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="approche-globale">Approche globale</h1><ol><li>Sauter le pas d'un coup ?</li><li><dl><dt>Faire des petits pas ?</dt><dd><ol><li>Reproduire le comportement pr&#xE9;c&#xE9;dent ?</li><li>En profiter pour d&#xE9;gager les reliquats ?</li></ol></dd></dl></li></ol></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><img src="UrzaTowerFall_2048x2048.jpg" width="1000px"></img></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="bug-1882025">Bug 1882025</h1><p>Remove duplicate <tt>is_gcc</tt> and <tt>building_with_gcc</tt> checks from <tt>toolchain.configure</tt></p></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><img src="UrzaTowerIsland_2048x2048.jpg" width="1000px"></img></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="bug-1915837">Bug 1915837</h1><p>Remove unused reference to <tt>PYTHON3_VERSION</tt> from <tt>configure</tt></p><p>Unused since <tt>Bug 1755530</tt></p></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><img src="UrzaTowerMountain_2048x2048.jpg" width="1000px"></img></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="bug-1904612">Bug 1904612</h1><p>Move <tt>HOST_OPTIMIZE_FLAGS</tt> from <tt>old-configure</tt> to <tt>moz.configure</tt></p><p>With two changes:</p><ul><li>no longer honors <tt>HOST_OPTIMIZE_FLAGS</tt> environment variable, which it previously did but without advertising it</li><li>the value is now based on the compiler type and not the target</li></ul></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><img src="UrzaTowerSpring_2048x2048.jpg" width="1000px"></img></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="bug-1883782">Bug 1883782</h1><p>Move <tt>pthread</tt> checks from <tt>old-configure</tt> to <tt>moz.configure</tt></p><ul><li>Get rid of <tt>-pthreads</tt> because (according to gcc info page) it's only
there on solaris and as an alias to <tt>-pthread</tt>.</li><li><tt>-D_REENTRANT</tt> is always defined by gcc and clang when -pthreads is on.</li><li><tt>-D_THREAD_SAFE</tt> is only defined on AIX by clang</li><li><tt>libpthreads</tt> is an AIX thing, I assume we can remove it too.</li></ul></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><img src="Balance1993_2048x2048.jpg" width="1000px"></img></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="tester-l-intestable">Tester l'intestable</h1><p>Firefox est construit par Mozilla, mais aussi par</p><ul><li>des packageurs (Debian, RedHat, BSD&#x2026;)</li><li>des projets tiers (LibreWorlf, IceCat&#x2026;)</li><li>des particuliers</li></ul><p>Avec plein de configurations diff&#xE9;rentes !</p><pre class="highlight code sh">$<span class="w"> </span>./mach<span class="w"> </span>configure<span class="w"> </span>--<span class="w"> </span>--help<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="w">
</span><span class="m">436</span></pre></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="the-scream-test">The Scream Test</h1><blockquote><p>If you see something</p><p>and you don&#x2019;t know what it does,</p><p>remove it</p><p>and see if anyone screams.</p></blockquote></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><h1 id="dette-technique">Dette Technique</h1><p>Les bons choix d'hier ne sont pas forc&#xE9;ment les bons choix de demain</p><p>Comme en histoire : ne pas juger une &#xE9;poque avec notre regard contemporain</p></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><h1 id="rince-and-repeat">Rince and Repeat?</h1><p>Comment approcher positivement le d&#xE9;couplage du syst&#xE8;me de build vis-&#xE0;-vis de
GNU make ?</p></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="41600" data-y="0" data-z="0"><img src="BirdsofParadise_2048x2048.jpg" width="1000px"></img></div></div><div id="slide-number" class="slide-number">
         1
      </div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/gotoSlide.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
      document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
    </script></body></html>