<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Optimizing the core of Python Scientific Stack</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="optimizing-the-core-of-python-scientific-stack">Optimizing the core of Python Scientific Stack</h1><p><em>Serge &#xAB; sans paille &#xBB; Guelton &lt;serge.guelton@telecom-bretagne.eu&gt;</em></p><p>Journ&#xE9;e Python &#x2014; PySciDataGre &#x2014; mars 2018</p><p><em>adapted from a talk at PyData Paris and one at FOSDEM 2018</em></p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="about-me">About me</h1><ul><li>R&amp;D engineer on compilation for security @ QuarksLab</li><li>Associate Researcher at Telecom Bretagne</li><li>Happy developer of <a href="https://github.com/serge-sans-paille/pythran">Pythran</a></li><li><a href="http://gatherer.wizards.com/Pages/Card/Details.aspx?name=soldier%20of%20fortune">Soldier of Fortune</a></li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="about-python">About Python</h1><p>Python is getting wide adoption in the Scientific community:</p><ul><li>Nice plots (Matplotlib)</li><li>Scientific libraries (Scipy)</li><li>Domain-specific libraries (Scikit-learn, Astropy&#x2026;)</li><li>Notebooks (Jupyter)</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="about-numpy">About Numpy</h1><p>The core of all the stack!</p><ul><li>data-centric abstraction</li><li>elegant array DSL</li><li>relatively good performance</li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="don-t-forget-fortran">Don't forget FORTRAN</h1><p>Sometimes, performance is paramount, and Numpy does not fit</p><ul><li>no parallelisation</li><li>no vectorization</li><li>intermediate result</li><li>genericity &gt;&gt; performance</li></ul></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="about-pythran">About Pythran</h1><ul><li>A compiler for scientific kernels</li><li>A DSL embeded in Python</li></ul><pre class="highlight code Python"><span class="c1">#pythran export rosen(int[])</span>
<span class="c1">#pythran export rosen(float[])</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">rosen</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">t1</span><span class="p">)</span></pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="a-niche-target">A Niche Target</h1><h2 id="performance-and-python">Performance and Python</h2><ul><li>Wide choice of optimizing solutions: Cython / Numexpr / Numba&#x2026;</li></ul><h2 id="compilation-and-python">Compilation and Python</h2><ul><li>Long term projects like PyPy, Cython (PyRex), Jython&#x2026;</li><li>Recent Projects like Numba, hope&#x2026;</li><li>Dead Projects like copperhead, Pyston, Unladen Swallow, Parakeet</li></ul></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="ideas-in-the-air">Ideas in the Air</h1><h2 id="basics-likely-to-work">Basics (likely to work)</h2><ul><li>Type variable declarations</li><li>Do assumptions on the imported modules</li><li>Support a subset of the language / environment</li></ul><h2 id="advanced-require-some-time">Advanced (require some time)</h2><ul><li>Perform <strong>compiler</strong> optimization</li><li>Just-In-Time compilation</li><li>Support a <strong>large</strong> subset of the language / environment</li></ul><h2 id="expert-brain-damaging">Expert (brain damaging)</h2><ul><li>Compatible with Python's lazy binding</li><li>Compatible with native extensions</li></ul></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="id1">Pythran</h1><h2 id="open-source-software">Open Source Software</h2><ul><li>Started on 2012</li><li>BSD 3-clause</li><li>Available on <a href="https://pypi.python.org/pypi/pythran">Pypi</a>, <a href="https://anaconda.org/serge-sans-paille/pythran">Conda</a> and <a href="https://github.com/serge-sans-paille/pythran">GitHub</a></li></ul><h2 id="dependencies">Dependencies</h2><ul><li>Numpy / networkx / ply / gast [easy]</li><li>A <strong>standard-compilant</strong> C++11 compiler [used to be challenging]</li></ul></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="choice-consequences">Choice &amp; Consequences</h1><h2 id="idea-1">Idea #1</h2><p>Generate Python-free code (apart from conversion)</p><h2 id="profit">Profit</h2><p>Can release the GIL relatively early</p></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="choice-consquences">Choice &amp; Consquences</h1><h2 id="idea-2">Idea #2</h2><p>Emulate duck-typing through static polymorphism</p><h2 id="id2">Profit</h2><p>Very light type inference code, let <tt>template</tt> instantiation magic do the job</p></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="id3">Choice &amp; Consquences</h1><h2 id="idea-3">Idea #3</h2><p>Generate High-level C++ code</p><h2 id="id4">Profit</h2><ul><li>Can write a high-level C++ support library as <em>intrinsics</em></li><li>OpenMP support inside Python</li></ul></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="how-does-it-work">How does it work?</h1><pre class="highlight code">      module.py           Pythran                 g++
          +            -----------&gt;  module.cpp -------&gt;  module.so
#pythran export foo(int)</pre></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="just-a-translator">Just a translator?</h1><p><strong>No</strong></p></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="id5">Just a translator?</h1><p>C++ is just a conveninent <a class="footnoteref" id="footnote-backref-id6" href="#footnote-id7">[*]</a> backend</p><h2 id="source-to-source-toolbox">Source-to-Source toolbox</h2><pre class="highlight code">pythran/
    analyses/         # abstract the ast
    transformations/  # transform the ast
    optimizations/    # optimize the ast</pre><div class="footnote" id="footnote-id7"><a class="footnotereturn" href="#footnote-backref-id6" title="return to content">#*: </a><p>Really convenient</p></div></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="analyses">Analyses</h1><ul><li>Use-def-chains</li><li>Memory effects, Argument effects, Global effects</li><li>AST matcher</li><li>Constant expressions</li><li>Lazyness analysis</li><li>Pure expression</li><li>Value range</li></ul></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="optimizations">Optimizations</h1><ul><li>Iterator Unrolling</li><li>Interprocedural Constant Folding</li><li>Remove Modulo on Induction Variable</li><li>Forward Substitution</li><li>Inst Combine</li><li>Range based simplification</li><li>Dead code elimination</li></ul></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="high-level-approach">High Level Approach?</h1><pre class="highlight code cython"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>

    <span class="n">xc</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">xc</span> <span class="o">+=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">xs</span> <span class="o">+=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span>
        <span class="n">cc</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">ss</span> <span class="o">+=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">s</span>
        <span class="n">cs</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">s</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="mf">2</span> <span class="o">*</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cc</span> <span class="o">-</span> <span class="n">ss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2</span> <span class="o">*</span> <span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">c_tau</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">s_tau</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">c_tau2</span> <span class="o">=</span> <span class="n">c_tau</span> <span class="o">*</span> <span class="n">c_tau</span>
    <span class="n">s_tau2</span> <span class="o">=</span> <span class="n">s_tau</span> <span class="o">*</span> <span class="n">s_tau</span>
    <span class="n">cs_tau</span> <span class="o">=</span> <span class="mf">2</span> <span class="o">*</span> <span class="n">c_tau</span> <span class="o">*</span> <span class="n">s_tau</span>

    <span class="n">pgram</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(((</span><span class="n">c_tau</span> <span class="o">*</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">s_tau</span> <span class="o">*</span> <span class="n">xs</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span> <span class="o">/</span> \
        <span class="p">(</span><span class="n">c_tau2</span> <span class="o">*</span> <span class="n">cc</span> <span class="o">+</span> <span class="n">cs_tau</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">+</span> <span class="n">s_tau2</span> <span class="o">*</span> <span class="n">ss</span><span class="p">))</span> <span class="o">+</span> \
        <span class="p">((</span><span class="n">c_tau</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">s_tau</span> <span class="o">*</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mf">2</span> <span class="o">/</span> \
        <span class="p">(</span><span class="n">c_tau2</span> <span class="o">*</span> <span class="n">ss</span> <span class="o">-</span> <span class="n">cs_tau</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">+</span> <span class="n">s_tau2</span> <span class="o">*</span> <span class="n">cc</span><span class="p">)))</span></pre></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="id8">High Level Approach!</h1><pre class="highlight code python"><span class="c1"># Local variables</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cc</span> <span class="o">-</span> <span class="n">ss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">freqs</span><span class="p">)</span>
<span class="n">c_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">freqs</span> <span class="o">*</span> <span class="n">tau</span><span class="p">)</span>
<span class="n">s_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">freqs</span> <span class="o">*</span> <span class="n">tau</span><span class="p">)</span>
<span class="n">c_tau2</span> <span class="o">=</span> <span class="n">c_tau</span> <span class="o">*</span> <span class="n">c_tau</span>
<span class="n">s_tau2</span> <span class="o">=</span> <span class="n">s_tau</span> <span class="o">*</span> <span class="n">s_tau</span>
<span class="n">cs_tau</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c_tau</span> <span class="o">*</span> <span class="n">s_tau</span>

<span class="n">pgram</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(((</span><span class="n">c_tau</span> <span class="o">*</span> <span class="n">xc</span> <span class="o">+</span> <span class="n">s_tau</span> <span class="o">*</span> <span class="n">xs</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> \
    <span class="p">(</span><span class="n">c_tau2</span> <span class="o">*</span> <span class="n">cc</span> <span class="o">+</span> <span class="n">cs_tau</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">+</span> <span class="n">s_tau2</span> <span class="o">*</span> <span class="n">ss</span><span class="p">))</span> <span class="o">+</span> \
    <span class="p">((</span><span class="n">c_tau</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">s_tau</span> <span class="o">*</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> \
    <span class="p">(</span><span class="n">c_tau2</span> <span class="o">*</span> <span class="n">ss</span> <span class="o">-</span> <span class="n">cs_tau</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">+</span> <span class="n">s_tau2</span> <span class="o">*</span> <span class="n">cc</span><span class="p">)))</span></pre></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="advanced-kernels">Advanced Kernels</h1><pre class="highlight code python"><span class="c1">#from http://stackoverflow.com/questions/26823312/numba-or-cython\</span>
<span class="c1">#            -acceleration-in-reaction-diffusion-algorithm</span>
<span class="c1">#pythran export GrayScott(int, float, float, float, float)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">GrayScott</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">Du</span><span class="p">,</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">u</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">nd2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">U</span><span class="p">[</span><span class="n">nd2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">nd2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">nd2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">nd2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.50</span>
    <span class="n">V</span><span class="p">[</span><span class="n">nd2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">nd2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">nd2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">nd2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="n">u</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span></pre></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="id9">Advanced Kernels</h1><pre class="highlight code python"><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="n">uvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
        <span class="n">Lu</span> <span class="o">=</span> <span class="p">(</span>                 <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
              <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
                               <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Lv</span> <span class="o">=</span> <span class="p">(</span>                 <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
              <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
                               <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">uvv</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">v</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="n">Du</span><span class="o">*</span><span class="n">Lu</span> <span class="o">-</span> <span class="n">uvv</span> <span class="o">+</span> <span class="n">F</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">+=</span> <span class="n">Dv</span><span class="o">*</span><span class="n">Lv</span> <span class="o">+</span> <span class="n">uvv</span> <span class="o">-</span> <span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>

    <span class="k">return</span> <span class="n">V</span></pre></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="technical-discoveries">Technical Discoveries</h1><h2 id="openmp-support">OpenMP Support</h2><pre class="highlight code python"><span class="c1">#pythran export some_stuff(float64[])</span>
<span class="c1">#pythran export some_stuff(float32[;,:])</span>
<span class="k">def</span> <span class="nf">some_stuff</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="c1">#omp parallel for reduction(+:r)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">r</span></pre><p>Including OpenMP's atomic, critical, task and libomp :-)</p></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="id10">Technical Discoveries</h1><h2 id="cython-support">Cython Support</h2><pre class="highlight code python"><span class="c1"># cython: np_pythran=True</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">cimport</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">cnp</span>

<span class="k">def</span> <span class="nf">diffuse_numpy</span><span class="p">(</span><span class="n">cnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">]</span> <span class="n">u</span><span class="p">,</span> <span class="nb">int</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">cdef</span> <span class="n">cnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">]</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="il">2L</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="il">2L</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">u</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:]</span>
        <span class="n">temp</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span></pre><p>Thanks to Adrien Guinet &amp; OpenDreamKit!</p></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="id11">Technical Discoveries</h1><h2 id="jupyter-internals">Jupyter Internals</h2><pre class="highlight code python"><span class="o">%%</span><span class="n">pythran</span> <span class="o">-</span><span class="n">O2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c1">#pythran export foo(int[:,:])</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><h1 id="id12">Technical Discoveries</h1><h2 id="python-capsule">Python Capsule</h2><pre class="highlight code python"><span class="c1">#pythran capsule export foo(int[:,:])</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><h1 id="thanks">Thanks</h1><ul><li><a href="https://www.silkan.com/">Silkan</a> for the original idea and funding</li><li><a href="https://opendreamkit.org/">OpenDreamKit</a> for a European grant</li><li><a href="http://calcul.math.cnrs.fr/">Group Calcul</a> for the regular meetings</li><li><a href="https://linuxfr.org/journaux">LinuxFR</a> <em>Bonjour'nal !</em></li></ul><h1 id="contribute">Contribute!</h1><p>In random order:</p><ul><li>Bug reports</li><li>Pull requests</li><li>Fundings</li><li>Praise, Flame and Smalltalk</li></ul></div></div><div id="slide-number" class="slide-number">
        1
      </div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
        document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
      </script></body></html>