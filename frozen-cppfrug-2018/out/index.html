<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Frozen data structures meet constexpr</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="frozen-data-structures-meet-constexpr">Frozen data structures meet constexpr</h1><p><em>Serge &#xAB; sans paille &#xBB; Guelton &lt;serge.guelton@telecom-bretagne.eu&gt;</em></p><p>Cpp French User Group &#x2014; Lut&#xE8;ce &#x2014; mars 2018</p><p><em>sous l'influence de Chris Beck et J&#xE9;r&#xF4;me Dumesnil</em></p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="about-me">About me</h1><ul><li>R&amp;D engineer on compilation for security @ QuarksLab</li><li>Associate Researcher at Telecom Bretagne</li><li>Happy developer of <a href="https://github.com/serge-sans-paille/pythran">Pythran</a></li><li><a href="http://gatherer.wizards.com/Pages/Card/Details.aspx?name=soldier%20of%20fortune">Soldier of Fortune</a></li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="foreword">Foreword</h1><ul><li>All benchmarks are compiled using <tt>g++ -O2 -std=c++14</tt></li></ul><pre class="highlight code sh">$ g++ --version
g++ <span class="o">(</span>Debian <span class="m">7</span>.3.0-11<span class="o">)</span> <span class="m">7</span>.3.0</pre><ul><li>All benchmarks are run on an Intel i7-6600U (i.e. my laptop) using Google benchamrk</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="about-perfect-minimal-hashing">About Perfect Minimal Hashing</h1><ul><li><em>perfect</em>:<blockquote><p>no collision</p></blockquote></li><li><em>minimal</em><blockquote><p>memory usage in O(n)</p></blockquote></li></ul><p><tt>gperf</tt> implements that.</p></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="const-is-not-rodata"><tt>const</tt> is not <tt>.rodata</tt></h1><pre class="highlight code c++"><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">nekrataal</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata a.o
...
<span class="m">0</span>:  <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">08</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>

$ objdump -S -Mintel -j .text.startup a.o <span class="p">|</span> wc -l
<span class="m">74</span></pre></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="constexpr-is-the-new-const"><tt>constexpr</tt> is the new <tt>const</tt></h1><p>With a <tt>constexpr</tt> constructor:</p><pre class="highlight code c++"><span class="k">extern</span> <span class="k">const</span> <span class="n">frozen</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">nekrataal</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata a.o
...
<span class="m">0</span>:  <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">08</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>

$ objdump -S -Mintel -j .text.startup a.o <span class="p">|</span> wc -l
objdump: section <span class="s1">'.text.startup'</span> mentioned in a -j option, <span class="se">\
</span>    but not found in any input file</pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="use-case-string-enum">Use Case: string &#x22C4; enum</h1><pre class="highlight code c++"><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">c_keyword</span><span class="p">,</span> <span class="mi">32</span><span class="o">&gt;</span> <span class="n">Keywords</span><span class="p">{</span>
    <span class="p">{</span><span class="s">"auto"</span><span class="p">,</span> <span class="n">KW_AUTO</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"break"</span><span class="p">,</span> <span class="n">KW_BREAK</span><span class="p">},</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="s">"volatile"</span><span class="p">,</span> <span class="n">KW_VOLATILE</span><span class="p">},</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="use-case-static-config">Use Case: Static Config</h1><blockquote><p>Date: Wed, 28 Mar 2018 15:21:51 +0000
From: Chris Beck &lt;xxxxxxxxx&gt;
To: serge guelton &lt;yyyyyyyy&gt;
Subject: Re: Frozen use at Tesla</p><p>Tesla autopilot uses shared memory segments (...).</p><p>At time of writing, we have an enum that describes all of the different shared memory segments
used by different parts of the program, and a struct that describes the
configuration of each segment &#x2013; (...).</p><p>In the past we had a <tt>const std::map</tt> for this. Now we use a <tt>frozen::map</tt>,
which simplifies the startup of the tasks.</p></blockquote></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="why-shrink-the-binaries">Why? Shrink the binaries</h1><h2 id="enum-style">enum style</h2><p><tt>.o</tt> size: <strong>6072</strong> bytes</p><pre class="highlight code c++"><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="nf">enum_to_string</span><span class="p">(</span><span class="n">RELOC_i386</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="nl">R_386_NONE</span><span class="p">:</span> <span class="k">return</span> <span class="s">"NONE"</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="nl">R_386_32</span><span class="p">:</span> <span class="k">return</span> <span class="s">"R32"</span><span class="p">;</span>
    <span class="p">...</span></pre></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="id1">Why? Shrink the binaries</h1><h2 id="std-map-style">std::map style</h2><p><tt>.o</tt> size: <strong>8496</strong> bytes</p><pre class="highlight code c++"><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">RELOC_i386</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">e2s</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_NONE</span><span class="p">,</span>          <span class="s">"NONE"</span><span class="p">},</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_32</span><span class="p">,</span>            <span class="s">"R32"</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">};</span>


<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="nf">enum_to_string</span><span class="p">(</span><span class="n">RELOC_i386</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">e2s</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="id2">Why? Shrink the binaries</h1><h2 id="frozen-map-style">frozen::map style</h2><p><tt>.o</tt> size: <strong>4088</strong> bytes</p><pre class="highlight code c++"><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">RELOC_i386</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="mi">41</span><span class="o">&gt;</span> <span class="n">e2s</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_NONE</span><span class="p">,</span>          <span class="s">"NONE"</span><span class="p">},</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_32</span><span class="p">,</span>            <span class="s">"R32"</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">};</span>


<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="nf">enum_to_string</span><span class="p">(</span><span class="n">RELOC_i386</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">e2s</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="why-accelerate-the-binaries">Why? Accelerate the binaries</h1><p>Sucessively look for all elements in a set of 32 integers:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_IntInFzSet                    1672 ns       1672 ns     417271
BM_IntInStdSet                   5748 ns       5747 ns     119478
BM_IntInStdArray                 2749 ns       2749 ns     254695</pre></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="id3">Why? Accelerate the binaries</h1><p>Sucessively look for elements not in a set of 32 integers:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_IntNotInFzSet                 1668 ns       1667 ns     417931
BM_IntNotInStdSet                5899 ns       5899 ns     115567
BM_IntNotInStdArray              3645 ns       3643 ns     192033</pre></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="id4">Why? Accelerate the binaries</h1><p>Sucessively look for elements in a <tt>unordered_set</tt> of 32 strings:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_StrInFzUnorderedSet           2583 ns       2583 ns     268092
BM_StrInStdUnorderedSet          4802 ns       4800 ns     145135
BM_StrInStdArray                 4829 ns       4829 ns     146107</pre></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="id5">Why? Accelerate the binaries</h1><p>Sucessively look for elements not in an <tt>unordered_set</tt> of 32 strings:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_StrInFzUnorderedSet           2583 ns       2583 ns     268092
BM_StrInStdUnorderedSet          4802 ns       4800 ns     145135
BM_StrInStdArray                 4829 ns       4829 ns     146107</pre></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="compile-time-binary-search">Compile Time Binary Search</h1><pre class="highlight code cpp"><span class="cp">#include</span> <span class="cpf">&lt;frozen/set.h&gt;</span><span class="cp">
</span><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span> <span class="mi">15</span><span class="o">&gt;</span> <span class="n">primes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">47</span><span class="p">};</span>

<span class="kt">bool</span> <span class="nf">is_small_prime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">primes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="compile-time-binary-search-assembly">Compile Time Binary Search: Assembly</h1><p>Compiler with clang for (almost) branchless code</p><pre class="highlight code sh">$ clang a.c -O2 -std<span class="o">=</span>c++14 -c
$ objdump -S -Mintel -j .text a.o

<span class="m">0000000000000000</span> &lt;_Z14is_small_primei&gt;:
   <span class="m">0</span>:       <span class="m">83</span> ff <span class="m">13</span>                cmp    <span class="nv">$0</span>x13,%edi
   <span class="m">3</span>:       b8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>          mov    <span class="nv">$0</span>x0,%eax
   <span class="m">8</span>:       b9 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>          mov    <span class="nv">$0</span>x0,%ecx
   d:       <span class="m">48</span> 0f <span class="m">47</span> c8             cmova  %rax,%rcx
  <span class="m">11</span>:       <span class="m">39</span> <span class="m">79</span> 0c                cmp    %edi,0xc<span class="o">(</span>%rcx<span class="o">)</span>
  <span class="m">14</span>:       <span class="m">48</span> 8d <span class="m">41</span> <span class="m">10</span>             lea    0x10<span class="o">(</span>%rcx<span class="o">)</span>,%rax
  <span class="m">18</span>:       <span class="m">48</span> 0f <span class="m">43</span> c1             cmovae %rcx,%rax
  1c:       <span class="m">39</span> <span class="m">78</span> <span class="m">04</span>                cmp    %edi,0x4<span class="o">(</span>%rax<span class="o">)</span>
  1f:       <span class="m">48</span> 8d <span class="m">48</span> <span class="m">08</span>             lea    0x8<span class="o">(</span>%rax<span class="o">)</span>,%rcx
  <span class="m">23</span>:       <span class="m">48</span> 0f <span class="m">43</span> c8             cmovae %rax,%rcx
  <span class="m">27</span>:       <span class="m">39</span> <span class="m">39</span>                   cmp    %edi,<span class="o">(</span>%rcx<span class="o">)</span>
  <span class="m">29</span>:       <span class="m">48</span> 8d <span class="m">41</span> <span class="m">04</span>             lea    0x4<span class="o">(</span>%rcx<span class="o">)</span>,%rax
  2d:       <span class="m">48</span> 0f <span class="m">43</span> c1             cmovae %rcx,%rax
  <span class="m">31</span>:       b9 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>          mov    <span class="nv">$0</span>x0,%ecx
  <span class="m">36</span>:       <span class="m">48</span> <span class="m">39</span> c8                cmp    %rcx,%rax
  <span class="m">39</span>:       <span class="m">74</span> <span class="m">06</span>                   je     <span class="m">41</span> &lt;_Z14is_small_primei+0x41&gt;
  3b:       <span class="m">39</span> <span class="m">38</span>                   cmp    %edi,<span class="o">(</span>%rax<span class="o">)</span>
  3d:       0f <span class="m">96</span> c0                setbe  %al
  <span class="m">40</span>:       c3                      retq
  <span class="m">41</span>:       <span class="m">31</span> c0                   xor    %eax,%eax
  <span class="m">43</span>:       c3                      retq</pre></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="compile-time-hashing-aka-gperf">Compile Time Hashing, aka <tt>gperf</tt></h1><ol><li>Read the original <a href="http://stevehanov.ca/blog/index.php?id=119">blog post by Steve Hanov</a></li><li>Choose a dummy hash function</li><li>Parametrize it by a random parameter, eg<blockquote><pre class="highlight code c++"><span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span>
<span class="k">operator</span><span class="p">()(</span><span class="n">string</span> <span class="n">value</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">seed</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span> <span class="o">=</span> <span class="n">seed</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mh">0x01000193</span><span class="p">)</span> <span class="o">^</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span></pre></blockquote></li></ol></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="id6">Compile Time Hashing, aka <tt>gperf</tt></h1><img src="intermediate.png"></img></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="id7">Compile Time Hashing, aka <tt>gperf</tt></h1><ol><li>Starting with the buckets with more collisions, iteratively look for a seed that generates no collision in the final table</li><li>Store this seed in the intermediate table, and process next bucket</li></ol><p>Sounds too random? there's a paper that states it's in O(n) :-)</p></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="bonus-use-frozen-in-a-meta-program">Bonus: Use Frozen in a meta program</h1><p>All methods calls are <tt>constexpr</tt> thus...</p><pre class="highlight code c++"><span class="cp">#include</span> <span class="cpf">&lt;frozen/set.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span>
<span class="n">supported_sizes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
<span class="p">};</span>

<span class="k">static_assert</span><span class="p">(</span><span class="n">supported_sizes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)),</span>
              <span class="s">"unsupported size"</span><span class="p">);</span></pre></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="bonus-compile-time-initialization-of-string-search">Bonus: Compile Time initialization of string search</h1><p>From c++17</p><pre class="highlight code c++"><span class="n">std</span><span class="o">::</span><span class="n">search</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">in</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="n">std</span><span class="o">::</span><span class="n">boyer_moore_searcher</span><span class="p">(</span><span class="n">needle</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                                      <span class="n">needle</span><span class="p">.</span><span class="n">end</span><span class="p">())</span></pre><p>Make the init phase constexpr!</p><pre class="highlight code c++"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">haystack</span> <span class="o">=</span> <span class="s">"ABC ABCDAB ABCDABCDABDE"</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">index</span> <span class="o">=</span> <span class="n">frozen</span><span class="o">::</span><span class="n">search</span><span class="p">(</span>
    <span class="n">haystack</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">haystack</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
    <span class="n">frozen</span><span class="o">::</span><span class="n">make_boyer_moore_searcher</span><span class="p">(</span><span class="s">"ABCDABD"</span><span class="p">)</span>
<span class="p">);</span></pre></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="frozen-in-lief">Frozen in LIEF</h1><p>LIEF - Library to Instrument Executable Formats <a href="https://lief.quarkslab.com">https://lief.quarkslab.com</a></p><ul><li>Uses Frozen for fast and efficient storage of enums</li><li>Plan to use Frozen for fast <tt>strstr</tt></li></ul></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="frozen-tesla">Frozen @ Tesla</h1><p>Contributor to the project!</p><p>Uses frozen for</p><ul><li>Various enum interactions</li><li>Static configuration storage</li><li>Avoid SIOF</li></ul></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><h1 id="frozen-home">Frozen @ home</h1><p>Store a colormap:</p><pre class="highlight code cpp"><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">ColorMap</span><span class="p">{</span>
    <span class="p">{</span><span class="sc">'R'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">'G'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">'B'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">'#'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">' '</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">}},</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><h1 id="id8">Frozen @ home</h1><p>And use it to turn ASCIIART into PPM <em>at compile time</em></p><pre class="highlight code cpp"><span class="k">constexpr</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bytes</span><span class="p">[]</span> <span class="o">=</span>
    <span class="s">"      ######      "</span>
    <span class="s">"    ##GGGG  ##    "</span>
    <span class="s">"   #  GGGG    #   "</span>
    <span class="s">"  #  GGGGGG    #  "</span>
    <span class="s">"  # GG    GG   #  "</span>
    <span class="s">" #GGG      GGGGG# "</span>
    <span class="s">" #GGG      GG  G# "</span>
    <span class="s">" # GG      G    # "</span>
    <span class="s">" #  GG    GG    # "</span>
    <span class="s">" #  GGGGGGGGG  G# "</span>
    <span class="s">" # GG########GGG# "</span>
    <span class="s">"  ###  #  #  ###  "</span>
    <span class="s">"   #   #  #   #   "</span>
    <span class="s">"   #          #   "</span>
    <span class="s">"    #        #    "</span>
    <span class="s">"     ########     "</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="41600" data-y="0" data-z="0"><h1 id="credits">Credits</h1><p>Thanks to Quarkslab for allowing me to sped time on that project.</p><p>Kudos to Chris Beck and  J&#xE9;r&#xF4;me Dumesnil for the common work!</p><pre class="highlight code sh">$ lynx https://github.com/serge-sans-paille/frozen</pre></div></div><div id="slide-number" class="slide-number">
        1
      </div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
        document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
      </script></body></html>