<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Using C++ as a C on steroids</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><img src="SergeGuelton.png" width="1200"></img></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="this"><tt>*this</tt></h1><p>Serge &#xAB; sans paille &#xBB; Guelton</p><pre class="highlight code">(gdb) p me
$1 = {goblin_tinkerer = true, orcish_lumberjack = true,
  monastery_swiftspear = true}</pre></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="dad-s-joke">Dad's Joke</h1><blockquote><p><tt>C++</tt> is exactly that:</p><p>increment <tt>C</tt> and return the old value</p></blockquote></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="abandon-your-ego">Abandon your ego</h1><ul><li>No more runtime type information</li><li>No more exceptions</li><li>No more standard library runtime</li><li>No more standard library headers (?)</li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="removing-rtti">Removing RTTI</h1><p><tt>-fno-rtti</tt></p><ol><li>(almost) No more <tt>dynamic_cast&lt;...&gt;(...)</tt></li><li>No more <tt>typeid(...)</tt></li></ol><p>But keeps the type information needed for exceptions</p></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="workaround">Workaround</h1><blockquote><p>from libcxx</p></blockquote><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_Tp</span><span class="o">&gt;</span>
<span class="k">struct</span>  <span class="n">__unique_typeinfo</span> <span class="p">{</span> <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">__id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_Tp</span><span class="o">&gt;</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">__unique_typeinfo</span><span class="o">&lt;</span><span class="n">_Tp</span><span class="o">&gt;::</span><span class="n">__id</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">_Tp</span><span class="o">&gt;</span>
<span class="kr">inline</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">__get_fallback_typeid</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">__unique_typeinfo</span><span class="o">&lt;</span><span class="n">remove_cv_t</span><span class="o">&lt;</span><span class="n">remove_reference_t</span><span class="o">&lt;</span><span class="n">_Tp</span><span class="o">&gt;&gt;&gt;::</span><span class="n">__id</span><span class="p">;</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="removing-exception">Removing Exception</h1><blockquote><p><tt>-fno-exceptions</tt></p></blockquote><ol><li>No more exception throwing / catching</li><li>Still register function unwinders</li></ol></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="id1">Workaround</h1><blockquote><p>from frozen</p></blockquote><pre class="highlight code c++"><span class="cp">#if (defined(_MSC_VER) &amp;&amp; !defined(_CPPUNWIND)) || \
    (!defined(_MSC_VER) &amp;&amp; !defined(__cpp_exceptions))
</span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#define FROZEN_THROW_OR_ABORT(_) std::abort()
</span>
<span class="cp">#else
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdexcept&gt;</span><span class="cp">
#define FROZEN_THROW_OR_ABORT(err) throw err
</span>
<span class="cp">#endif</span></pre></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="removing-the-standard-library-runtime">Removing the standard library runtime</h1><blockquote><p><tt>s/g++/gcc</tt> as linker. Say goodbye to&#x2026;</p></blockquote><ol><li>non-header only types / functions</li><li>some template functions that are explicitly instanciated</li><li><dl><dt>language features that require library support</dt><dd><ul><li>default <tt>new</tt> / <tt>delete</tt></li><li>in-function static constructors</li></ul></dd></dl></li></ol><p>Placement new are still ok :-)</p></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="id2">Workaround</h1><pre class="highlight code c++"><span class="kt">void</span><span class="o">*</span> <span class="k">operator</span> <span class="nf">new</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="k">operator</span> <span class="nf">delete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="remove-almost-all-the-things">Remove (almost) all the things</h1><blockquote><p><tt>-ffreestanding</tt> (See also: <tt>-mkernel</tt>)</p></blockquote><p>A few allowed headers, including:</p><ul><li><tt>&lt;cstddef&gt;</tt>, <tt>&lt;limits&gt;</tt>, <tt>&lt;new&gt;</tt>, <tt>&lt;initializer_list&gt;</tt></li><li><tt>&lt;type_traits&gt;</tt>, <tt>&lt;concepts&gt;</tt></li></ul><p>Exceptions and typeid are still in!</p><ul><li><tt>&lt;exception&gt;</tt>, <tt>&lt;typeinfo&gt;</tt></li></ul><p>And most surprisingly</p><ul><li><tt>&lt;coroutine&gt;</tt></li></ul></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><img src="no.jpg" width="1200"></img></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="what-s-left-when-you-gave-up-everything">What's left when you gave up everything?</h1><blockquote><p>A very Cool C language :-)</p></blockquote><ul><li><tt>constexpr</tt></li><li><tt>template&lt;...&gt;</tt></li><li><tt>auto</tt></li><li>range-based loops</li><li>encapsulation, inheritance (including diamond!)</li><li>stronger typing</li></ul></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="three-tales">Three tales</h1><ol><li>GCC</li><li>LLVM</li><li>Numpy</li></ol></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="gcc">GCC</h1><p><a href="https://gcc.gnu.org/codingconventions.html">https://gcc.gnu.org/codingconventions.html</a></p><p>&gt; C++ is a complex language, and we strive to use it in a manner that is not surprising</p><ul><li>conversion</li><li>overload</li><li>operator</li><li>default arguments</li><li><tt>&lt;iostream&gt;</tt></li><li><tt>-no-rtti</tt>, <tt>-no-exceptions</tt></li></ul></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="llvm">LLVM</h1><p><a href="https://llvm.org/docs/CodingStandards.html">https://llvm.org/docs/CodingStandards.html</a></p><ul><li>no static constructors</li><li>no generalized initialization syntax</li><li>beware of copies whith <tt>auto</tt></li><li><tt>-no-rtti</tt>, <tt>-no-exceptions</tt></li></ul></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="numpy">Numpy</h1><p>PR#19713 (merged)</p><p>&gt; Replace numpy custom generation engine by raw C++</p><ul><li><tt>-no-rtti</tt>, <tt>-no-exceptions</tt></li><li>not linking with standard library</li></ul></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="clang-tidy"><tt>clang-tidy</tt></h1><ul><li><tt>cppcoreguidelines</tt></li><li><tt>llvm</tt></li></ul></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="concluding-words">Concluding words</h1><p>It's okay to see C++ as a <strong>protean language</strong></p><ul><li>Pick the feature you want</li><li>Be aware of the dependencies between features</li><li>Document or write tools to enforce your choice</li></ul><img src="goblin_tinkerer.jpg" width="600" align="center"></img></div></div><div id="slide-number" class="slide-number">
         1
      </div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/gotoSlide.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
      document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
    </script></body></html>