<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Improving Compile-Time Computation of Object Size</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="improving-compile-time-computation-of-object-size">Improving Compile-Time Computation of Object Size</h1><p><strong>Serge &#xAB; sans paille &#xBB; Guelton</strong></p><p>Compiler Engineer / Story Teller / Mozilla Employee</p><p><strong>FOSDEM &#x2014; 1st February 2025</strong></p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="builtin-object-size-ptr-0"><tt>__builtin_object_size(ptr, 0)</tt></h1><ul><li>Yields the constant number of bytes from <tt>ptr</tt> to the end of the object
<tt>ptr</tt> points to.</li><li>If unknown at compile time, returns <strong>-1</strong>.</li><li>If <tt>ptr</tt> can point to several objects, returns the <strong>maximum</strong> of remaining
bytes count across all potential objects.</li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="builtin-object-size-ptr-1"><tt>__builtin_object_size(ptr, 1)</tt></h1><ul><li>Yields the constant number of bytes from <tt>ptr</tt> to the end of the object
<tt>ptr</tt> points to.</li><li>If unknown at compile time, returns <strong>-1</strong>.</li><li>If <tt>ptr</tt> can point to several objects, returns the <strong>minimum</strong> of remaining
bytes count across all potential objects.</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="builtin-object-size-ptr-2"><tt>__builtin_object_size(ptr, 2)</tt></h1><ul><li>Yields the constant number of bytes from <tt>ptr</tt> to the end of the object
<tt>ptr</tt> points to.</li><li>If unknown at compile time, returns <strong>0</strong>.</li><li>If <tt>ptr</tt> can point to several objects, returns the <strong>maximum</strong> of remaining
bytes count across all potential objects.</li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="builtin-object-size-ptr-3"><tt>__builtin_object_size(ptr, 3)</tt></h1><ul><li>Yields the constant number of bytes from <tt>ptr</tt> to the end of the object
<tt>ptr</tt> points to.</li><li>If unknown at compile time, returns <strong>0</strong>.</li><li>If <tt>ptr</tt> can point to several objects, returns the <strong>minimum</strong> of remaining
bytes count across all potential objects.</li></ul></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="usage-0">Usage (0)</h1><p>Under <tt>-D_FORTIFY_SOURCE=[123]</tt></p><pre class="highlight code c"><span class="n">__fortify_function</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="n">__NTH</span><span class="w"> </span><span class="p">(</span><span class="n">stpncpy</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">__dest</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">__src</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">__n</span><span class="p">))</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__bos</span><span class="w"> </span><span class="p">(</span><span class="n">__dest</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="w">
      </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">__builtin_constant_p</span><span class="w"> </span><span class="p">(</span><span class="n">__n</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">__n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">__bos</span><span class="w"> </span><span class="p">(</span><span class="n">__dest</span><span class="p">)))</span><span class="w">
    </span><span class="k">return</span><span class="w"> </span><span class="n">__stpncpy_chk</span><span class="w"> </span><span class="p">(</span><span class="n">__dest</span><span class="p">,</span><span class="w"> </span><span class="n">__src</span><span class="p">,</span><span class="w"> </span><span class="n">__n</span><span class="p">,</span><span class="w"> </span><span class="n">__bos</span><span class="w"> </span><span class="p">(</span><span class="n">__dest</span><span class="p">));</span><span class="w">
  </span><span class="k">return</span><span class="w"> </span><span class="n">__stpncpy_alias</span><span class="w"> </span><span class="p">(</span><span class="n">__dest</span><span class="p">,</span><span class="w"> </span><span class="n">__src</span><span class="p">,</span><span class="w"> </span><span class="n">__n</span><span class="p">);</span><span class="w">
</span><span class="p">}</span></pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="usage-1">Usage (1)</h1><p>For sanitizers:</p><pre class="highlight code sh">%<span class="w"> </span>git<span class="w"> </span>grep<span class="w"> </span>-l<span class="w"> </span>ObjectSizeOffset<span class="w"> </span>llvm/lib<span class="w">
</span>llvm/lib/Analysis/MemoryBuiltins.cpp<span class="w">
</span>llvm/lib/Transforms/IPO/AttributorAttributes.cpp<span class="w">
</span>llvm/lib/Transforms/Instrumentation/AddressSanitizer.cpp<span class="w">
</span>llvm/lib/Transforms/Instrumentation/BoundsChecking.cpp</pre></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="comparison-between-gcc-and-clang">Comparison between GCC and Clang</h1><p>from: <a href="https://github.com/serge-sans-paille/builtin_object_size-test-suite">https://github.com/serge-sans-paille/builtin_object_size-test-suite</a></p><p>With gcc 14.2.1:</p><pre class="highlight code sh">%<span class="w"> </span>make<span class="w"> </span><span class="nv">CC</span><span class="o">=</span>gcc<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>g++<span class="w">
</span>g++<span class="w"> </span>-O2<span class="w"> </span>-fno-inline<span class="w">    </span>check-staticxx.cpp<span class="w">   </span>-o<span class="w"> </span>check-staticxx<span class="w">
</span>./check-static<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">static</span><span class="o">=</span><span class="nv">$?</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>./check-staticxx<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">staticxx</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$static</span><span class="w"> </span>+<span class="w"> </span><span class="nv">$staticxx</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="sb">`</span><span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:243<span class="w"> </span>check_if_then_negative_offset:<span class="w"> </span><span class="m">8</span><span class="w"> </span>-<span class="w"> </span><span class="m">2</span><span class="w"> </span>-<span class="w"> </span>max<span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span><span class="w"> </span>+<span class="w"> </span><span class="m">2</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>ptr<span class="w"> </span>-<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">5</span><span class="w"> </span>got<span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:374<span class="w"> </span>check_static_posix_memalign:<span class="w"> </span>n<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>m,<span class="w"> </span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">7</span><span class="w"> </span>got<span class="w"> </span>-1<span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:464<span class="w"> </span>check_conditional_storing_in_arg:<span class="w"> </span>max<span class="o">(</span>n0,<span class="w"> </span>n1<span class="o">)</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>*mem,<span class="w"> </span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">8</span><span class="w"> </span>got<span class="w"> </span>-1<span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:465<span class="w"> </span>check_conditional_storing_in_arg:<span class="w"> </span>max<span class="o">(</span>n0,<span class="w"> </span>n1<span class="o">)</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>*mem,<span class="w"> </span><span class="m">1</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">8</span><span class="w"> </span>got<span class="w"> </span>-1<span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:466<span class="w"> </span>check_conditional_storing_in_arg:<span class="w"> </span>min<span class="o">(</span>n0,<span class="w"> </span>n1<span class="o">)</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>*mem,<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">5</span><span class="w"> </span>got<span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-staticxx.cpp:30<span class="w"> </span>check_placement_new:<span class="w"> </span>sizeof<span class="o">(</span>double<span class="o">)</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>mem,<span class="w"> </span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">8</span><span class="w"> </span>got<span class="w"> </span>-1</pre><p>Could be better, but that's <em>correct</em></p></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="comparison-between-gcc-and-clang-1">Comparison between GCC and Clang</h1><p>With clang 18.1.8:</p><pre class="highlight code sh">%<span class="w"> </span>make<span class="w"> </span><span class="nv">CC</span><span class="o">=</span>clang<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>clang++<span class="w">
</span>clang<span class="w"> </span>-O2<span class="w"> </span>-fno-inline<span class="w">    </span>check-static.c<span class="w">   </span>-o<span class="w"> </span>check-static<span class="w">
</span>clang++<span class="w"> </span>-O2<span class="w"> </span>-fno-inline<span class="w">    </span>check-staticxx.cpp<span class="w">   </span>-o<span class="w"> </span>check-staticxx<span class="w">
</span>./check-static<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">static</span><span class="o">=</span><span class="nv">$?</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>./check-staticxx<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">staticxx</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$static</span><span class="w"> </span>+<span class="w"> </span><span class="nv">$staticxx</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="sb">`</span><span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:241<span class="w"> </span>check_if_then_negative_offset:<span class="w"> </span><span class="m">8</span><span class="w"> </span>-<span class="w"> </span><span class="m">2</span><span class="w"> </span>-<span class="w"> </span>min<span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span><span class="w"> </span>+<span class="w"> </span><span class="m">2</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>ptr<span class="w"> </span>-<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">8</span><span class="w"> </span>got<span class="w"> </span>-1<span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:242<span class="w"> </span>check_if_then_negative_offset:<span class="w"> </span><span class="m">8</span><span class="w"> </span>-<span class="w"> </span><span class="m">2</span><span class="w"> </span>-<span class="w"> </span>min<span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span><span class="w"> </span>+<span class="w"> </span><span class="m">2</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>ptr<span class="w"> </span>-<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">1</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">8</span><span class="w"> </span>got<span class="w"> </span>-1<span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:243<span class="w"> </span>check_if_then_negative_offset:<span class="w"> </span><span class="m">8</span><span class="w"> </span>-<span class="w"> </span><span class="m">2</span><span class="w"> </span>-<span class="w"> </span>max<span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">3</span><span class="o">)</span><span class="w"> </span>+<span class="w"> </span><span class="m">2</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>ptr<span class="w"> </span>-<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">2</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">5</span><span class="w"> </span>got<span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="o">[</span>FAIL<span class="o">]</span><span class="w"> </span>check-static.c:335<span class="w"> </span>check_static_reallocarray:<span class="w"> </span>n<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>__builtin_object_size<span class="o">(</span>m,<span class="w"> </span><span class="m">0</span><span class="o">)</span>,<span class="w"> </span>expecting<span class="w"> </span><span class="m">100</span><span class="w"> </span>got<span class="w"> </span>-1</pre><p>Could be okay if those were not <strong>OK</strong> with previous clang <tt>;_;</tt></p></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="test-case-dissection">Test Case Dissection</h1><pre class="highlight code c"><span class="kt">void</span><span class="w"> </span><span class="nf">check_if_then_negative_offset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">
  </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
    </span><span class="n">ptr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
  </span><span class="n">CHECK</span><span class="p">(</span><span class="n">__builtin_object_size</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">
  </span><span class="p">...</span><span class="w">
</span><span class="p">}</span></pre><p>What kind of LLVM bitcode do we have there?</p></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="test-case-bitcode-o0">Test Case Bitcode (<tt>-O0</tt>)</h1><pre class="highlight code llvm"><span class="w">  </span><span class="nv-Anonymous">%12</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">[</span><span class="m">8</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">2</span><span class="w">
  </span><span class="k">store</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%12</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w">
  </span><span class="nv-Anonymous">%13</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@rand</span><span class="p">()</span><span class="w"> </span><span class="vg">#12</span><span class="w">
  </span><span class="nv-Anonymous">%14</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv-Anonymous">%13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="nv-Anonymous">%15</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">ne</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv-Anonymous">%14</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w">
  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv-Anonymous">%15</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv-Anonymous">%16</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv-Anonymous">%19</span><span class="w">

</span><span class="nl">16:</span><span class="w">
  </span><span class="nv-Anonymous">%17</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w">
  </span><span class="nv-Anonymous">%18</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%17</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">3</span><span class="w">
  </span><span class="k">store</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%18</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w">
  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv-Anonymous">%19</span><span class="w">

</span><span class="nl">19:</span><span class="w">
  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv-Anonymous">%20</span><span class="w">

</span><span class="nl">20:</span><span class="w">
  </span><span class="k">store</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%3</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w">
  </span><span class="nv-Anonymous">%21</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w">
  </span><span class="nv-Anonymous">%22</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%21</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">-2</span><span class="w">
  </span><span class="nv-Anonymous">%23</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="vg">@llvm.objectsize.i64.p0</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv-Anonymous">%22</span><span class="p">,</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="k">false</span><span class="p">,</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="k">false</span><span class="p">)</span></pre></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="pick-your-poison">Pick Your Poison</h1><p>The previous code can be optimized into:</p><ol><li>A <tt>phi</tt> instruction, which only requires pointer analysis to fold
<tt>@llvm.objectsize</tt></li><li>A <tt>select</tt> instruction, which requires offset analysis to fold
<tt>@llvm.objectsize</tt></li></ol><p>Guess what changed in recent LLVM version?</p></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="about-select-instruction-analysis">About <tt>select</tt> instruction analysis</h1><p>If the pointer offset depends on a <tt>select</tt> value, let's use <tt>llvm::computeConstantRange</tt>, but&#x2026;</p><ul><li><tt>llvm::computeConstantRange</tt> is smart</li><li><tt>llvm.builtin_object_size</tt> is used for security check</li></ul><p>Can that be a problem?</p></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="about-not-being-smart">About <strong>not</strong> Being Smart</h1><p><strong>Question</strong>: <em>Do you want to take advantage of undefined behaviors when you track undefined behaviors?</em></p><p><strong>Question</strong>: <em>Is there an interest in large over-approximation when folding BoS?</em></p><p><strong>Question</strong>: <em>Do approximations made by</em> <tt>llvm::computeConstantRange</tt> <em>match the definition of origins of BoS?</em></p><p>If the answer to one of those is <em>no</em>, implement a simpler version of value tracking.</p></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="implement-a-simple-value-tracking">Implement a Simple Value Tracking</h1><ol><li>Only track values, no range optimizations</li><li>Simple arithmetic</li><li>No undefined behavior were harmed during this execution</li></ol><p>See PR #117849</p></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="in-the-end">In the End</h1><pre class="highlight code sh"><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>~/sources/llvm-project/_build/bin:<span class="nv">$PATH</span><span class="w">
</span>make<span class="w"> </span><span class="nv">CC</span><span class="o">=</span>clang<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>clang++<span class="w">
</span>clang<span class="w"> </span>-O2<span class="w"> </span>-fno-inline<span class="w">    </span>check-static.c<span class="w">   </span>-o<span class="w"> </span>check-static<span class="w">
</span>clang++<span class="w"> </span>-O2<span class="w"> </span>-fno-inline<span class="w">    </span>check-staticxx.cpp<span class="w">   </span>-o<span class="w"> </span>check-staticxx<span class="w">
</span>./check-static<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">static</span><span class="o">=</span><span class="nv">$?</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>./check-staticxx<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nv">staticxx</span><span class="o">=</span><span class="nv">$?</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$static</span><span class="w"> </span>+<span class="w"> </span><span class="nv">$staticxx</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="sb">`</span></pre><p>Yay, back to the state from 4 years ago <tt>\o/</tt></p></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="bonus-point">Bonus Point</h1><p>Model <tt>reallocarray(3)</tt></p><pre class="highlight code c"><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">reallocarray</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">_Nullable</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nmemb</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span></pre><p>See PR #114818</p></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="did-i-say-simple">Did I Say Simple?</h1><p>Approximations and GEP</p><pre class="highlight code c"><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w">
</span><span class="kt">int</span><span class="w"> </span><span class="n">coffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span><span class="w">
</span><span class="kt">long</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__builtin_object_size</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coffset</span><span class="p">,</span><span class="w"> </span><span class="n">MODE</span><span class="p">)</span></pre><ul><li><tt>MODE==0</tt> &#x21D2; max value for <tt>bos</tt> &#x21D2; min value for <tt>coffset</tt></li><li><tt>MODE==2</tt> &#x21D2; min value for <tt>bos</tt> &#x21D2; max value for <tt>coffset</tt></li></ul></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="special-thanks">Special Thanks</h1><ul><li>To Mozilla for letting me working on that borderline topic for a build
engineer</li><li>Harald van Dijk <tt>@hvdijk</tt> for reviewing my patches and providing countless
counter examples</li></ul></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="concluding-words">Concluding Words</h1><ul><li><tt>__builtin_object_size</tt> brings extra compiler power to the user, it's a fun intrinsic</li><li><tt>__builtin_object_size</tt> now supports a wider range of scenario</li><li>@llvm.objectsize` is key to some security features of LLVM</li><li>Did you know about <tt>__builtin_dynamic_object_size</tt>?</li></ul></div></div><div id="slide-number" class="slide-number">
         1
      </div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/gotoSlide.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
      document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
    </script></body></html>