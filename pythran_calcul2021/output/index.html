<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>The Pythran compiler</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="intro">Intro</h1><p><strong>Python</strong> and <strong>Science</strong>: the great mystery</p><p>Python isn't known for its baffling <em>performance</em></p><p>Scientific computing <tt>&lt;3</tt> <em>performance</em> (think Fortran)</p><p>Yet they love each other, which paves the way for <strong>accelerating solutions</strong></p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="the-pythran-compiler">The Pythran compiler</h1><p><strong>Serge &#xAB; sans paille &#xBB; Guelton</strong></p><p>Compiler Engineer / Wood Craft Lover</p><p><strong>Groupe Calcul &#x2014; 24th September 2021</strong></p></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="in-a-nutshell">In a nutshell</h1><p>A <em>non-intrusive</em> compiler for scientific kernels written in <em>Python</em></p><pre class="highlight code Python"><span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1">#pythran export log_likelihood(float64[], float64,</span>
<span class="c1">#                              float64)</span>
<span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
  <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
  <span class="n">pdfs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">s</span><span class="p">)</span>
  <span class="n">pdfs</span> <span class="o">/=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span>
  <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pdfs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></pre><pre class="highlight code shell"><span class="c1"># native parallel vectorized module
</span>pythran log_likelihood.py -fopenmp <span class="se">\
</span>        -march<span class="o">=</span>native -DUSE_XSIMD</pre></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="what-about-cython">What about... Cython?</h1><ul><li>Cython introduces an (optional) new <em>dialect</em></li><li>Cython allows <em>mixed mode</em> execution</li></ul><p><strong>Upside</strong>:</p><ul><li>Huge <em>user base</em> (numpy, scipy, scikit-<tt>*</tt>)</li><li><em>Graduate</em> conversion</li><li>Nice <em>error reporting</em></li><li>Nice <em>profiling</em> support through (<tt>cython -a</tt>)</li><li>Low 3rd party requirements (<tt>cc</tt>)</li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="what-about-pypy">What about... PyPy?</h1><ul><li>PyPy is a full (jitting) <em>interpreter</em></li><li>PyPy ha[sd] limited Numpy acceleration</li><li>Strong <em>theoretical</em> and <em>engineering</em> foundations</li></ul><p>Upside:</p><ul><li><em>Full</em> language support</li></ul></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="what-about-numba">What about... Numba?</h1><ul><li>Numba favors explicit <em>JIT</em> compilation</li><li>Numba favors an explicit, <em>low-level</em> style</li><li>Based on the <em>LLVM</em> compiler infrastructure</li></ul><p>Upside:</p><ul><li>Powered by the <tt>conda</tt> <em>package manager</em></li><li>Good <em>adoption</em> in the community</li><li>Easy <em>integration</em> (<tt>@numba.jit</tt>)</li></ul></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="compilers-4-stories">4 compilers, 4 stories</h1><p>Enough speak about others,</p><p>Let's dive into Pythran specificities</p></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="limitations">Limitations</h1><ul><li>no user-defined classes</li><li>no type polymorphism</li><li>no dynamic behavior</li><li>relatively slow compilation steps</li><li>hard to decrypt error message</li></ul></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="trading-for-good">Trading for good</h1><ul><li>high level abstractions</li><li>efficient looping</li><li>low entry cost</li><li>low exit cost</li></ul></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="installation-step">Installation step</h1><pre class="highlight code console"><span class="gp">$</span> pip install pythran
<span class="gp">$</span> conda install -c conda-forge pythran
<span class="gp">$</span> dnf install pythran
<span class="go">...
</span><span class="gp">$</span> git clone https://github.com/serge-sans-paille/pythran.git</pre></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="pythran-export">Pythran export</h1><p>Only comments, a tiny language to describe signatures and overloads:</p><pre class="highlight code python"><span class="c1">#pythran export kernel(int)</span>
<span class="c1">#pythran export kernel(float)</span>
<span class="c1">#pythran export kernel(complex128?)</span>
<span class="c1">#pythran export kernel(int[] or float[])</span>
<span class="c1">#pythran export kernel(int[], int[:,:])</span></pre></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="pythran-export-2">Pythran export - 2</h1><p>Some types are copied:</p><pre class="highlight code python"><span class="c1">#pythran export kernel(int set or int list or int:str dict)</span></pre><p>Shape fine-tuning:</p><pre class="highlight code python"><span class="c1">#pythran export kernel(int8[:, 3])</span></pre><p>Strided and transposed views</p><pre class="highlight code python"><span class="c1">#pythran export kernel(int8[::,:])</span>
<span class="c1">#pythran export kernel(int8[:,:].T)</span></pre></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="static-polymorphism">Static Polymorphism</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

<span class="n">foo</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">foo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></pre></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="option-types">Option Types</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">foo</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">foo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">foo</span><span class="p">(</span><span class="mf">4.</span><span class="p">)</span></pre></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="pythran-and-openmp">Pythran and OpenMP</h1><p>Mostly OpenMP3, bits of OpenMP4</p><pre class="highlight code"># inspired by https://software.intel.com/en-us/node/695675
def min_abs(omp_in, omp_out):
  return min(abs(omp_in), omp_out)

import numpy as np
def find_min_abs(data):
  'return the smallest magnitude among all the integers in data[N]'
  result = abs(data[0])
  #omp declare reduction(minabs : int :  \
     omp_out = min_abs(omp_in, omp_out)) \
     initializer(omp_priv=omp_orig)

  #omp parallel for reduction(minabs: result)
  for d in data:
    if abs(d) &lt; result:
      result = abs(d)
  return result</pre></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="supported-modules-packages">Supported Modules/Packages</h1><ul><li><tt>builtins</tt></li><li><tt>math</tt>, <tt>cmath</tt></li><li><tt>itertool, ``functional</tt></li><li><tt>random</tt></li><li><tt>numpy</tt>, <tt>numpy.random</tt>, <tt>scipy.special</tt></li></ul><p>Almost always partial support!</p></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="on-the-shoulder-of-a">On the shoulder of a&#x2026;</h1><p>Pythran dependencies:</p><ul><li>gast (generic ast)</li><li>beniget (use-def-chains for Python)</li><li>xsimd (vectorizer abstraction)</li><li>boost.math (some scientific functions)</li></ul></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="from-a-notebook">From a Notebook</h1><p>Requires an extension, provides a new cell magic:</p><pre class="highlight code console"><span class="gp">&gt;</span> %load_ext pythran.magic
<span class="gp">&gt;</span> %%pythran
<span class="gp">#</span>pythran <span class="nb">export</span> foo<span class="o">(</span>int<span class="o">)</span>
<span class="go">def foo(n): return n
</span><span class="gp">&gt;</span> print<span class="o">(</span>foo<span class="o">(</span><span class="m">3</span><span class="o">))</span></pre></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="from-a-shell">From a shell</h1><pre class="highlight code console"><span class="gp">$</span> pythran kernel.py</pre><p>Sensible to common C++ flags: <tt>-O2</tt>, <tt>-ffast-math</tt> etc</p></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="from-distutils">From distutils</h1><pre class="highlight code python"><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">pythran.dist</span> <span class="kn">import</span> <span class="n">PythranExtension</span><span class="p">,</span> <span class="n">PythranBuildExt</span>

<span class="n">module1</span> <span class="o">=</span> <span class="n">PythranExtension</span><span class="p">(</span><span class="s1">'demo'</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a.py'</span><span class="p">])</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'demo'</span><span class="p">,</span>
      <span class="n">version</span> <span class="o">=</span> <span class="s1">'1.0'</span><span class="p">,</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s1">'This is a demo package'</span><span class="p">,</span>
      <span class="n">cmdclass</span><span class="o">=</span><span class="p">{</span><span class="s2">"build_ext"</span><span class="p">:</span> <span class="n">PythranBuildExt</span><span class="p">},</span>
      <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">module1</span><span class="p">])</span></pre></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="o-rdwr">O_RDWR</h1><p><a href="https://pythran.readthedocs.io">https://pythran.readthedocs.io</a></p><p>#pythran on iirc.oftc.net</p><p><a href="https://www.freelists.org/archive/pythran/">https://www.freelists.org/archive/pythran/</a></p><p><a href="https://github.com/serge-sans-paille/pythran/issues">https://github.com/serge-sans-paille/pythran/issues</a></p></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="some-pythran-successes">Some Pythran Successes</h1><ul><li>A short paper published in Nature:
<em>Reducing the ecological impact of computing through education and Python compilers</em></li><li>A build dependency for Scipy</li><li>Available in many distros: Fedora, Archlinux, Gentoo&#x2026; and (ITP) Debian!</li><li>Used in the industry (Universal Audio)</li></ul></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="random-thoughts">Random thoughts</h1><ul><li><dl><dt>Users matters:</dt><dd><ul><li>Portability across Python versions</li><li>Portability across OS and arches</li></ul></dd></dl></li><li>Not being an industrial project is fine</li><li><dl><dt>Make it fun:</dt><dd><ul><li>Write articles (and not only code)</li><li>Share ideas</li><li>Meet people</li></ul></dd></dl></li></ul></div></div><div id="slide-number" class="slide-number">
         1
      </div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/gotoSlide.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
      document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
    </script></body></html>