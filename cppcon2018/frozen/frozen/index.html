<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Frozen data structures in C++14</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="frozen-data-structures-in-c-14">Frozen data structures in C++14</h1><p><em>Serge &#xAB; sans paille &#xBB; Guelton &lt;serge.guelton@quarkslab.com&gt;</em></p><p>CppCon 2018 -- USA / 23 -- 29 September 2018</p><p><em>under the influence of Chris Beck and J&#xE9;r&#xF4;me Dumesnil</em></p><p><em>with the great help of Austin McCartney's CMake knowledge</em></p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="about-me">About me</h1><ul><li>R&amp;D engineer on compilation for security @ QuarksLab</li><li>Associate Researcher at Telecom Bretagne</li><li>Happy developer of <a href="https://github.com/serge-sans-paille/pythran">Pythran</a></li><li>(modest) LLVM commiter</li><li>Proud father</li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="foreword">Foreword</h1><ul><li>All benchmarks are compiled using <tt>g++ -O2 -std=c++14</tt></li></ul><pre class="highlight code sh">$ g++ --version
g++ <span class="o">(</span>Debian <span class="m">7</span>.3.0-11<span class="o">)</span> <span class="m">7</span>.3.0</pre><ul><li>All benchmarks are run on an Intel i7-6600U (i.e. my laptop) using Google benchamrk</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="const-means-rodata"><tt>const</tt> means <tt>.rodata</tt>?</h1><pre class="highlight code c++"><span class="cp">#include</span> <span class="cpf">&lt;array&gt;</span><span class="cp">
</span><span class="k">extern</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">uktabi</span> <span class="o">=</span>
     <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata uktabi.o
...
Disassembly of section .rodata:

<span class="m">0000000000000000</span> &lt;uktabi&gt;:
    <span class="m">0</span>:      <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">03</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">03</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>     ................

$ objdump -S -Mintel -j .text.startup uktabi.o <span class="p">|</span> wc -l
objdump: section <span class="s1">'.text.startup'</span> mentioned in a -j option,<span class="se">\
</span> but not found in any input file</pre></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="const-does-not-mean-no-initialization-cost"><tt>const</tt> does not mean no initialization cost!</h1><pre class="highlight code c++"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="k">extern</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">shiv</span> <span class="o">=</span>
    <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata shiv.o
...
Disassembly of section .rodata:

<span class="m">0000000000000000</span> &lt;shiv&gt;:
    <span class="m">0</span>:      <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">03</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">03</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>     ................

$ sobjdump -S -Mintel -j .text.startup shiv.o <span class="p">|</span> wc -l
<span class="m">35</span></pre></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="what-about-std-set">What about <tt>std::set</tt>?</h1><pre class="highlight code c++"><span class="cp">#include</span> <span class="cpf">&lt;set&gt;</span><span class="cp">
</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">nekrataal</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata a.o
...
<span class="m">0</span>:  <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">08</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>

$ objdump -S -Mintel -j .text.startup a.o <span class="p">|</span> wc -l
<span class="m">74</span></pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="no-static-equivalent">No static equivalent</h1><table cellpadding="0" cellspacing="0"><tbody><tr><td><p>std::vector</p></td><td><p>std::array</p></td></tr><tr><td><p>std::set</p></td><td><p>&#xF8;</p></td></tr><tr><td><p>std::map</p></td><td><p>&#xF8;</p></td></tr><tr><td><p>std::unordered_map</p></td><td><p>&#xF8;</p></td></tr><tr><td><p>std::unordered_set</p></td><td><p>&#xF8;</p></td></tr></tbody></table></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="let-it-go">Let it go!</h1><table cellpadding="0" cellspacing="0"><tbody><tr><td><p>std::vector</p></td><td><p>std::array</p></td></tr><tr><td><p>std::set</p></td><td><p><strong>frozen::set</strong></p></td></tr><tr><td><p>std::map</p></td><td><p><strong>frozen::map</strong></p></td></tr><tr><td><p>std::unordered_map</p></td><td><p><strong>frozen::unordered_set</strong></p></td></tr><tr><td><p>std::unordered_set</p></td><td><p><strong>frozen::unordered_map</strong></p></td></tr></tbody></table></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="frozen-set"><tt>frozen::set</tt></h1><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span>
          <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">N</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Compare</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;&gt;</span>
<span class="k">class</span> <span class="nc">set</span><span class="p">;</span></pre><p>Rational: a flat sorted <tt>std::array</tt> with binary-search.</p><p><tt>Compare</tt> needs to be <tt>constexpr</tt>-compatible.</p></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="frozen-map"><tt>frozen::map</tt></h1><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Value</span><span class="p">,</span>
          <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">N</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Compare</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;&gt;</span>
<span class="k">class</span> <span class="nc">map</span><span class="p">;</span></pre><p>Same as <tt>frozen::map</tt> but stores key, value pairs.</p></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="constexpr-is-the-new-const"><tt>constexpr</tt> is the new <tt>const</tt></h1><p>With a <tt>constexpr</tt> constructor:</p><pre class="highlight code c++"><span class="k">extern</span> <span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">nekrataal</span> <span class="o">=</span>
   <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata nekrataal.o
...
<span class="m">0</span>:  <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">08</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>

$ objdump -S -Mintel -j .text.startup nekrataal.o <span class="p">|</span> wc -l
objdump: section <span class="s1">'.text.startup'</span> mentioned in a -j option, <span class="se">\
</span>    but not found in any input file</pre></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="same-for-goes-map">Same for goes <tt>map</tt></h1><pre class="highlight code c++"><span class="k">extern</span> <span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">suqata</span> <span class="o">=</span>
   <span class="p">{</span> <span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="nb">true</span><span class="p">},</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="nb">false</span><span class="p">}</span> <span class="p">};</span></pre><pre class="highlight code sh">$ objdump -S -Mintel -j .rodata suqata.o
...
<span class="m">10</span>: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">07</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">08</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
<span class="m">20</span>: <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>

$ objdump -S -Mintel -j .text.startup suqata.o <span class="p">|</span> wc -l
objdump: section <span class="s1">'.text.startup'</span> mentioned in a -j option, <span class="se">\
</span>    but not found in any input file</pre></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="why-accelerate-the-binaries">Why? Accelerate the binaries</h1><p>Sucessively look for all elements in a set of 32 integers:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_IntInFzSet                         2174 ns       2163 ns     314909
BM_IntInStdSet                        7401 ns       7371 ns      93767
BM_IntInStdArray                      3594 ns       3581 ns     195584
BM_IntInStdArrayBinarySearch          3979 ns       3966 ns     176996</pre></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="id1">Why? Accelerate the binaries</h1><p>Sucessively look for elements not in a set of 32 integers:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_IntNotInFzSet                      2168 ns       2162 ns     319424
BM_IntNotInStdSet                     7668 ns       7649 ns      90889
BM_IntNotInStdArray                   4811 ns       4800 ns     145907
BM_IntNotInStdArrayBinarySearch       4000 ns       3992 ns     175349</pre></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="why-shrink-the-binaries">Why? Shrink the binaries</h1><h2 id="enum-style">enum style</h2><p><tt>.o</tt> size: <strong>6072</strong> bytes</p><pre class="highlight code c++"><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="nf">enum_to_string</span><span class="p">(</span><span class="n">RELOC_i386</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="nl">R_386_NONE</span><span class="p">:</span> <span class="k">return</span> <span class="s">"NONE"</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="nl">R_386_32</span><span class="p">:</span> <span class="k">return</span> <span class="s">"R32"</span><span class="p">;</span>
    <span class="p">...</span></pre></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="id2">Why? Shrink the binaries</h1><h2 id="std-map-style">std::map style</h2><p><tt>.o</tt> size: <strong>8496</strong> bytes</p><pre class="highlight code c++"><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">RELOC_i386</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">e2s</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_NONE</span><span class="p">,</span>          <span class="s">"NONE"</span><span class="p">},</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_32</span><span class="p">,</span>            <span class="s">"R32"</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">};</span>


<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="nf">enum_to_string</span><span class="p">(</span><span class="n">RELOC_i386</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">e2s</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="id3">Why? Shrink the binaries</h1><h2 id="frozen-map-style">frozen::map style</h2><p><tt>.o</tt> size: <strong>4088</strong> bytes</p><pre class="highlight code c++"><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">RELOC_i386</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="mi">41</span><span class="o">&gt;</span> <span class="n">e2s</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_NONE</span><span class="p">,</span>          <span class="s">"NONE"</span><span class="p">},</span>
    <span class="p">{</span> <span class="n">RELOC_i386</span><span class="o">::</span><span class="n">R_386_32</span><span class="p">,</span>            <span class="s">"R32"</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">};</span>


<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="nf">enum_to_string</span><span class="p">(</span><span class="n">RELOC_i386</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">e2s</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="about-perfect-minimal-hashing">About Perfect Minimal Hashing</h1><ul><li><em>perfect</em>:<blockquote><p>no collision</p></blockquote></li><li><em>minimal</em><blockquote><p>memory usage in $mathcal{O}(n)$</p></blockquote></li></ul><p><tt>gperf</tt> implements that.</p></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="remember-gperf">Remember <tt>gperf</tt></h1><pre class="highlight code sh">gperf titan.in &gt; titan.c</pre><pre class="highlight code">// titan.in
%%
Coeus
Crius
Cronus
Hyperion
...
Ophion
Pallas
Perses
Prometheus
Styx
%%</pre></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="equivalent-in-frozen">Equivalent in <tt>frozen</tt></h1><pre class="highlight code c++"><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="mi">33</span><span class="o">&gt;</span> <span class="n">Titans</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Coeus"</span><span class="p">,</span> <span class="s">"Crius"</span><span class="p">,</span> <span class="s">"Cronus"</span><span class="p">,</span> <span class="s">"Hyperion"</span><span class="p">,</span>
    <span class="s">"Iapetus"</span><span class="p">,</span> <span class="s">"Mnemosyne"</span><span class="p">,</span> <span class="s">"Oceanus"</span><span class="p">,</span> <span class="s">"Phoebe"</span><span class="p">,</span>
    <span class="s">"Rhea"</span><span class="p">,</span> <span class="s">"Tethys"</span><span class="p">,</span> <span class="s">"Theia"</span><span class="p">,</span> <span class="s">"Themis"</span><span class="p">,</span>
    <span class="s">"Asteria"</span><span class="p">,</span> <span class="s">"Astraeus"</span><span class="p">,</span> <span class="s">"Atlas"</span><span class="p">,</span> <span class="s">"Aura"</span><span class="p">,</span>
    <span class="s">"Clymene"</span><span class="p">,</span> <span class="s">"Dione"</span><span class="p">,</span> <span class="s">"Helios"</span><span class="p">,</span> <span class="s">"Selene"</span><span class="p">,</span>
    <span class="s">"Eos"</span><span class="p">,</span> <span class="s">"Epimetheus"</span><span class="p">,</span> <span class="s">"Eurybia"</span><span class="p">,</span> <span class="s">"Eurynome"</span><span class="p">,</span>
    <span class="s">"Lelantos"</span><span class="p">,</span> <span class="s">"Leto"</span><span class="p">,</span> <span class="s">"Menoetius"</span><span class="p">,</span> <span class="s">"Metis"</span><span class="p">,</span>
    <span class="s">"Ophion"</span><span class="p">,</span> <span class="s">"Pallas"</span><span class="p">,</span> <span class="s">"Perses"</span><span class="p">,</span> <span class="s">"Prometheus"</span><span class="p">,</span>
    <span class="s">"Styx"</span><span class="p">,</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="time-comparison">Time Comparison</h1><h2 id="bad-news">Bad news :-/</h2><p>gperf generated code may be faster than frozen's ($times$ 2 or 3)</p><h2 id="good-news">Good news :-)</h2><p>Customization point!</p><pre class="highlight code c++"><span class="k">struct</span> <span class="n">olaf</span> <span class="p">{</span>
  <span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="k">operator</span><span class="p">()(</span>
    <span class="n">frozen</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">seed</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">^</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mh">0x01000193</span><span class="p">)</span> <span class="o">^</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mh">0x01000193</span><span class="p">)</span> <span class="o">^</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="n">olaf</span><span class="o">&gt;</span> <span class="n">Titans</span> <span class="o">=</span> <span class="p">...</span></pre></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="frozen-unordered-set"><tt>frozen::unordered_set</tt></h1><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span>
          <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">N</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Hash</span> <span class="o">=</span> <span class="n">elsa</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">KeyEqual</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">equal_to</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;&gt;</span>
<span class="k">class</span> <span class="nc">unordered_set</span><span class="p">;</span></pre><p>Rational: not a one-liner :-)</p><p><tt>Hash</tt> and <tt>KeyEqual</tt> needs to be <tt>constexpr</tt></p></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="frozen-unordered-map"><tt>frozen::unordered_map</tt></h1><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Value</span><span class="p">,</span>
          <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">N</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">Hash</span> <span class="o">=</span> <span class="n">anna</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">KeyEqual</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">equal_to</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&gt;&gt;</span>
<span class="k">class</span> <span class="nc">unordered_map</span><span class="p">;</span></pre><p><tt>Hash</tt> and <tt>KeyEqual</tt> needs to be <tt>constexpr</tt></p></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="id4">Why? Accelerate the binaries</h1><p>Sucessively look for elements in a <tt>unordered_set</tt> of 32 strings:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_StrInFzUnorderedSet           2583 ns       2583 ns     268092
BM_StrInStdUnorderedSet          4802 ns       4800 ns     145135
BM_StrInStdArray                 4829 ns       4829 ns     146107</pre></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><h1 id="id5">Why? Accelerate the binaries</h1><p>Sucessively look for elements not in an <tt>unordered_set</tt> of 32 strings:</p><pre class="highlight code">------------------------------------------------------------------
Benchmark                           Time           CPU Iterations
------------------------------------------------------------------
BM_StrNotInFzUnorderedSet         2619 ns       2619 ns     266644
BM_StrNotInStdUnorderedSet        4204 ns       4204 ns     166675
BM_StrNotInStdArray               9392 ns       9392 ns      73318</pre></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><h1 id="compile-time-binary-search">Compile Time Binary Search</h1><pre class="highlight code cpp"><span class="cp">#include</span> <span class="cpf">&lt;frozen/set.h&gt;</span><span class="cp">
</span><span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span> <span class="mi">15</span><span class="o">&gt;</span> <span class="n">primes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">47</span><span class="p">};</span>

<span class="kt">bool</span> <span class="nf">is_small_prime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">primes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span></pre><p>Why is it faster?</p></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="41600" data-y="0" data-z="0"><h1 id="id6">Compile Time Binary Search</h1><pre class="highlight code sh">$ clang a.c -O2 -std<span class="o">=</span>c++14 -c
$ objdump -S -Mintel -j .text a.o
<span class="m">0000000000000000</span> &lt;_Z14is_small_primei&gt;:
   <span class="m">0</span>:       <span class="m">83</span> ff <span class="m">13</span>          cmp    <span class="nv">$0</span>x13,%edi
   <span class="m">3</span>:       b8 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>    mov    <span class="nv">$0</span>x0,%eax
   <span class="m">8</span>:       b9 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>    mov    <span class="nv">$0</span>x0,%ecx
   d:       <span class="m">48</span> 0f <span class="m">47</span> c8       cmova  %rax,%rcx
  <span class="m">11</span>:       <span class="m">39</span> <span class="m">79</span> 0c          cmp    %edi,0xc<span class="o">(</span>%rcx<span class="o">)</span>
  <span class="m">14</span>:       <span class="m">48</span> 8d <span class="m">41</span> <span class="m">10</span>       lea    0x10<span class="o">(</span>%rcx<span class="o">)</span>,%rax
  <span class="m">18</span>:       <span class="m">48</span> 0f <span class="m">43</span> c1       cmovae %rcx,%rax
  1c:       <span class="m">39</span> <span class="m">78</span> <span class="m">04</span>          cmp    %edi,0x4<span class="o">(</span>%rax<span class="o">)</span>
  1f:       <span class="m">48</span> 8d <span class="m">48</span> <span class="m">08</span>       lea    0x8<span class="o">(</span>%rax<span class="o">)</span>,%rcx
  <span class="m">23</span>:       <span class="m">48</span> 0f <span class="m">43</span> c8       cmovae %rax,%rcx
  <span class="m">27</span>:       <span class="m">39</span> <span class="m">39</span>             cmp    %edi,<span class="o">(</span>%rcx<span class="o">)</span>
  <span class="m">29</span>:       <span class="m">48</span> 8d <span class="m">41</span> <span class="m">04</span>       lea    0x4<span class="o">(</span>%rcx<span class="o">)</span>,%rax
  2d:       <span class="m">48</span> 0f <span class="m">43</span> c1       cmovae %rcx,%rax
  <span class="m">31</span>:       b9 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>    mov    <span class="nv">$0</span>x0,%ecx
  <span class="m">36</span>:       <span class="m">48</span> <span class="m">39</span> c8          cmp    %rcx,%rax
  <span class="m">39</span>:       <span class="m">74</span> <span class="m">06</span>             je     <span class="m">41</span> &lt;_Z14is_small_primei+0x41&gt;
  3b:       <span class="m">39</span> <span class="m">38</span>             cmp    %edi,<span class="o">(</span>%rax<span class="o">)</span>
  3d:       0f <span class="m">96</span> c0          setbe  %al
  <span class="m">40</span>:       c3                retq
  <span class="m">41</span>:       <span class="m">31</span> c0             xor    %eax,%eax
  <span class="m">43</span>:       c3                retq</pre></div><div class="step step-level-1" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="43200" data-y="0" data-z="0"><h1 id="trivia-original-code">Trivia: original code</h1><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">ForwardIt</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">N</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="n">ForwardIt</span> <span class="n">doit_fast</span><span class="p">(</span>
    <span class="n">ForwardIt</span> <span class="n">first</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="k">constexpr</span> <span class="n">step</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">static_assert</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span> <span class="o">==</span> <span class="n">N</span> <span class="o">-</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
               <span class="s">"power of two minus 1"</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">step</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">next_it</span> <span class="o">=</span> <span class="n">compare_</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">,</span> <span class="n">value_</span><span class="p">)</span>
                 <span class="o">?</span> <span class="n">it</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="o">:</span> <span class="n">first</span><span class="p">;</span>
  <span class="k">return</span> <span class="nf">doit_fast</span><span class="p">(</span><span class="n">next_it</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">{});</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="28" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="44800" data-y="0" data-z="0"><h1 id="compile-time-hashing-0">Compile Time Hashing (0)</h1><ol><li>Read the original <a href="http://stevehanov.ca/blog/index.php?id=119">blog post by Steve Hanov</a></li><li>Choose a dummy hash function</li><li>Parametrize it by a random parameter, e.g.<blockquote><pre class="highlight code c++"><span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span>
<span class="k">operator</span><span class="p">()(</span><span class="n">string</span> <span class="n">value</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">seed</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">d</span> <span class="o">=</span> <span class="n">seed</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="mh">0x01000193</span><span class="p">)</span> <span class="o">^</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span></pre></blockquote></li><li>Hash all the keys and fill buckets.</li></ol></div><div class="step step-level-1" step="29" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="46400" data-y="0" data-z="0"><h1 id="compile-time-hashing-1">Compile Time Hashing (1)</h1><ol><li>Starting with the buckets with more collisions, iteratively look for a seed that generates no collision in the final table</li><li>Store this seed in an intermediate table, and process next bucket</li></ol><p>Sounds random? It is! But there's a paper that states it's in <span class="math ">\(\mathcal{O}(n)\)</span>  :-)</p></div><div class="step step-level-1" step="30" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="48000" data-y="0" data-z="0"><h1 id="compile-time-hashing-2">Compile Time Hashing (2)</h1><img src="intermediate.png"></img><p><em>image credits: http://stevehanov.ca/blog/index.php?id=119</em></p></div><div class="step step-level-1" step="31" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="49600" data-y="0" data-z="0"><h1 id="details">Details</h1></div><div class="step step-level-1" step="32" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="51200" data-y="0" data-z="0"><h1 id="details-buckets">Details: buckets</h1><p>How to design a container that can grow while staying <tt>constexpr</tt>?</p><pre class="highlight code c++"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">N</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">cvector</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">data</span> <span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">dsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="33" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="52800" data-y="0" data-z="0"><h1 id="details-std-array-and-constexpr">Details: <tt>std::array</tt> and <tt>constexpr</tt></h1><p>Problems:</p><ol><li>No <tt>constexpr</tt> version of <tt>operator[](std::size_t) const</tt></li><li>Does <em>not</em> gracefully degrades when <tt>N == 0</tt>.</li></ol></div><div class="step step-level-1" step="34" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="54400" data-y="0" data-z="0"><h1 id="details-random-and-constexpr">Details: <tt>random</tt> and <tt>constexpr</tt></h1><p>Problems:</p><ol><li>The hash algorithm uses randomness</li><li>The termination proof requires a decent PRNG</li></ol><p><strong>&#x2192;</strong> Once the seed is fixed, a PRNG is 100% <tt>constexpr</tt> compatible.</p></div><div class="step step-level-1" step="35" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="56000" data-y="0" data-z="0"><h1 id="details-initialization">Details: Initialization</h1><pre class="highlight code c++"><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">mesa</span> <span class="o">=</span>
    <span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="sc">'1'</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="sc">'2'</span><span class="p">}};</span>
<span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span> <span class="kt">char</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">serra</span> <span class="o">=</span>
    <span class="p">{{</span><span class="mi">1</span><span class="p">,</span> <span class="sc">'1'</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="sc">'2'</span><span class="p">}};</span></pre><p>Problem:</p><ol><li>How to report size mismatch?</li></ol></div><div class="step step-level-1" step="36" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="57600" data-y="0" data-z="0"><h1 id="details-error-reporting">Details: Error Reporting</h1><pre class="highlight code c++"><span class="k">template</span><span class="o">&lt;</span><span class="kt">size_t</span> <span class="n">N</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">initializer_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// not ok: `s' is not a constant expression
</span>    <span class="k">static_assert</span><span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="s">"size mismatch"</span><span class="p">);</span>
    <span class="c1">// ok with recent compilers
</span>    <span class="n">assert</span><span class="p">(</span><span class="n">N</span> <span class="o">==</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="s">"size mismatch"</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="37" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="59200" data-y="0" data-z="0"><h1 id="details-exception-support">Details: Exception support</h1><p>Should a header-only library force a dependency on exceptions?</p><p>cf. specification of <tt>map::at</tt></p><pre class="highlight code c++"><span class="cp">#if defined(FROZEN_NO_EXCEPTIONS) ||\
    (defined(_MSC_VER) &amp;&amp; !defined(_CPPUNWIND)) ||\
    (defined(__cpp_exceptions) &amp;&amp; __cpp_exceptions)
</span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#define FROZEN_THROW_OR_ABORT(_) std::abort()
</span>
<span class="cp">#else
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdexcept&gt;</span><span class="cp">
#define FROZEN_THROW_OR_ABORT(err) throw err
</span>
<span class="cp">#endif</span></pre></div><div class="step step-level-1" step="38" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="60800" data-y="0" data-z="0"><h1 id="use-cases">Use Cases</h1></div><div class="step step-level-1" step="39" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="62400" data-y="0" data-z="0"><h1 id="use-case-string-enum">Use Case: string &#x22C4; enum</h1><pre class="highlight code c++"><span class="k">constexpr</span>
<span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">c_keyword</span><span class="p">,</span> <span class="mi">32</span><span class="o">&gt;</span>
<span class="n">Keywords</span><span class="p">{</span>
    <span class="p">{</span><span class="s">"auto"</span><span class="p">,</span> <span class="n">KW_AUTO</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"break"</span><span class="p">,</span> <span class="n">KW_BREAK</span><span class="p">},</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="s">"volatile"</span><span class="p">,</span> <span class="n">KW_VOLATILE</span><span class="p">},</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="40" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="64000" data-y="0" data-z="0"><h1 id="use-case-parsing">Use Case: Parsing</h1><pre class="highlight code c++"><span class="k">struct</span> <span class="n">codes_t</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">iCodepoint1</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">iCodepoint2</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="p">};</span>

<span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">frozen</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">codes_t</span><span class="o">&gt;</span>
<span class="n">s_Entities</span><span class="p">[]</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">"AElig"</span><span class="p">,</span> <span class="p">{</span>     <span class="mh">0xC6</span> <span class="p">}},</span>
    <span class="c1">// +2000 entities here
</span>    <span class="p">{</span> <span class="s">"zwnj"</span> <span class="p">,</span> <span class="p">{</span>   <span class="mh">0x200C</span> <span class="p">}},</span>
<span class="p">};</span>

<span class="k">constexpr</span> <span class="k">auto</span> <span class="n">s_NamedEntitiesHTML4</span> <span class="o">=</span>
    <span class="n">frozen</span><span class="o">::</span><span class="n">make_unordered_map</span><span class="p">(</span><span class="n">s_Entities</span><span class="p">);</span></pre></div><div class="step step-level-1" step="41" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="65600" data-y="0" data-z="0"><h1 id="use-case-static-config">Use Case: Static Config</h1><blockquote><p>Date: Wed, 28 Mar 2018 15:21:51 +0000
From: Chris Beck &lt;xxxxxxxxx&gt;
To: serge guelton &lt;yyyyyyyy&gt;
Subject: Re: Frozen use at Tesla</p><p>Tesla autopilot uses shared memory segments (...).</p><p>At time of writing, we have an enum that describes all of the different shared memory segments
used by different parts of the program, and a struct that describes the
configuration of each segment &#x2013; (...).</p><p>In the past we had a <tt>const std::map</tt> for this. Now we use a <tt>frozen::map</tt>,
which simplifies the startup of the tasks.</p></blockquote></div><div class="step step-level-1" step="42" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="67200" data-y="0" data-z="0"><h1 id="use-case-partial-memoization">Use Case: Partial Memoization</h1><pre class="highlight code cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">F</span><span class="p">,</span> <span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span><span class="p">...</span> <span class="n">Vs</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">memoized</span> <span class="p">{</span>

  <span class="k">auto</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
                                 <span class="k">decltype</span><span class="p">(</span><span class="n">F</span><span class="p">{}(</span><span class="n">v</span><span class="p">)),</span>
                                 <span class="k">sizeof</span><span class="p">...(</span><span class="n">Vs</span><span class="p">)</span><span class="o">&gt;</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="p">{{</span><span class="n">Vs</span><span class="p">,</span> <span class="n">F</span><span class="p">{}(</span><span class="n">Vs</span><span class="p">)}...};</span>
    <span class="k">auto</span> <span class="n">where</span> <span class="o">=</span> <span class="n">cached</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="n">cached</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">where</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">F</span><span class="p">{}(</span><span class="n">v</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="43" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="68800" data-y="0" data-z="0"><h1 id="bonus-use-frozen-in-a-meta-program">Bonus: Use Frozen in a meta program</h1><p>All methods calls are <tt>constexpr</tt> thus...</p><pre class="highlight code c++"><span class="cp">#include</span> <span class="cpf">&lt;frozen/set.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="n">frozen</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span>
<span class="n">supported_sizes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
<span class="p">};</span>

<span class="k">static_assert</span><span class="p">(</span><span class="n">supported_sizes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)),</span>
              <span class="s">"unsupported size"</span><span class="p">);</span></pre></div><div class="step step-level-1" step="44" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="70400" data-y="0" data-z="0"><h1 id="bonus-did-you-know-these-flags">Bonus: Did you know these flags?</h1><ul><li>gcc <tt>-fconstexpr-depth=N</tt>:<blockquote><p>Set the maximum nested evaluation depth for C++11 constexpr functions to N.</p></blockquote></li><li>gcc <tt>-fconstexpr-loop-limit=N</tt>:<blockquote><p>Set the maximum number of iterations for a loop in C++14 constexpr functions to N.</p></blockquote></li><li>clang <tt>-fconstexpr-steps=N</tt>:<blockquote><p>Maximum number of steps in constexpr function evaluation</p></blockquote></li><li>(...)</li></ul></div><div class="step step-level-1" step="45" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="72000" data-y="0" data-z="0"><h1 id="generalize-the-idea">Generalize the idea</h1><p>Frozen containers actually have two characteristics:</p><ol><li>A (possibly) non-trivial initialization step on constant data</li><li>A runtime step, on live or constant data</li></ol><p>The C++ compiler can make step 1. <span class="math ">\(\mathcal{O}(1)\)</span> and depending on the context, step 2. too.</p><p><strong>Any other algorithms that work that way?</strong></p><p><em>yes, algorithms with a precomputed table, like...</em></p></div><div class="step step-level-1" step="46" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="73600" data-y="0" data-z="0"><h1 id="compile-time-initialization-of-string-search">Compile Time initialization of string search</h1><p>From c++17</p><pre class="highlight code c++"><span class="n">std</span><span class="o">::</span><span class="n">search</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">in</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="n">std</span><span class="o">::</span><span class="n">boyer_moore_searcher</span><span class="p">(</span><span class="n">needle</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                                      <span class="n">needle</span><span class="p">.</span><span class="n">end</span><span class="p">())</span></pre><p>Make the init phase constexpr!</p><pre class="highlight code c++"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">haystack</span> <span class="o">=</span> <span class="s">"ABC ABCDAB ABCDABCDABDE"</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">index</span> <span class="o">=</span> <span class="n">frozen</span><span class="o">::</span><span class="n">search</span><span class="p">(</span>
    <span class="n">haystack</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">haystack</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
    <span class="n">frozen</span><span class="o">::</span><span class="n">make_boyer_moore_searcher</span><span class="p">(</span><span class="s">"ABCDABD"</span><span class="p">)</span>
<span class="p">);</span></pre><p><em>see also</em> the regexp talk by Hana Dus&#xED;kov&#xE1;</p></div><div class="step step-level-1" step="47" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="75200" data-y="0" data-z="0"><h1 id="frozen-in-lief">Frozen in LIEF</h1><p>LIEF - Library to Instrument Executable Formats <a href="https://lief.quarkslab.com">https://lief.quarkslab.com</a></p><ul><li>Uses Frozen for fast and efficient storage of enums</li><li>Plan to use Frozen for fast <tt>memmem</tt> on binary data.</li></ul></div><div class="step step-level-1" step="48" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="76800" data-y="0" data-z="0"><h1 id="frozen-tesla">Frozen @ Tesla</h1><p>Contributor to the project!</p><p>Uses frozen for:</p><ul><li>Various enum interactions</li><li>Static configuration storage</li><li>Avoid SIOF</li></ul></div><div class="step step-level-1" step="49" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="78400" data-y="0" data-z="0"><h1 id="frozen-home">Frozen @ home</h1><p>Store a colormap:</p><pre class="highlight code cpp"><span class="k">constexpr</span>
<span class="n">frozen</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span>
<span class="n">ColorMap</span><span class="p">{</span>
    <span class="p">{</span><span class="sc">'R'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">'G'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">'B'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">'#'</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">}},</span>
    <span class="p">{</span><span class="sc">' '</span><span class="p">,</span> <span class="p">{(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="mh">0xFF</span><span class="p">}},</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="50" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="80000" data-y="0" data-z="0"><h1 id="id7">Frozen @ home</h1><p>And use it to turn ASCIIART into PPM <em>at compile time</em></p><pre class="highlight code cpp"><span class="k">constexpr</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bytes</span><span class="p">[]</span> <span class="o">=</span>
    <span class="s">"      ######      "</span>
    <span class="s">"    ##GGGG  ##    "</span>
    <span class="s">"   #  GGGG    #   "</span>
    <span class="s">"  #  GGGGGG    #  "</span>
    <span class="s">"  # GG    GG   #  "</span>
    <span class="s">" #GGG      GGGGG# "</span>
    <span class="s">" #GGG      GG  G# "</span>
    <span class="s">" # GG      G    # "</span>
    <span class="s">" #  GG    GG    # "</span>
    <span class="s">" #  GGGGGGGGG  G# "</span>
    <span class="s">" # GG########GGG# "</span>
    <span class="s">"  ###  #  #  ###  "</span>
    <span class="s">"   #   #  #   #   "</span>
    <span class="s">"   #          #   "</span>
    <span class="s">"    #        #    "</span>
    <span class="s">"     ########     "</span>
<span class="p">};</span></pre></div><div class="step step-level-1" step="51" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="81600" data-y="0" data-z="0"><img src="1up.png" width="400px"></img></div><div class="step step-level-1" step="52" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="83200" data-y="0" data-z="0"><h1 id="credits">Credits</h1><p>Thanks to Quarkslab for allowing me to spend time on that project.</p><p><em>Kudos</em> to Chris Beck and  J&#xE9;r&#xF4;me Dumesnil for the common work!</p><pre class="highlight code sh">$ lynx https://github.com/serge-sans-paille/frozen</pre></div></div><div id="slide-number" class="slide-number">
        1
      </div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
        document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
      </script></body></html>