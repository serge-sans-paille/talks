<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Confronting Clang and Fedora</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="intro">Intro</h1><p>Fedora is a Linux Distribution, and <em>GCC</em> is its system compiler</p><p>What happens if an upstream package only supports <em>Clang</em> builds?</p><ul><li>Compatibility?</li><li>Feature parity?</li><li>Unexpected problems?</li></ul></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="confronting-clang-and-fedora">Confronting Clang and Fedora</h1><p><strong>Serge &#xAB; sans paille &#xBB; Guelton</strong></p><p>Compiler Engineer / Wood Craft Lover / RedHat employee</p><p><strong>FOSDEM'20 &#x2014; 1st february 2020</strong></p></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="it-that-started-all">It that started all</h1><p>Original work started because of this <em>thread</em>:</p><p><a href="https://pagure.io/fesco/issue/2020">https://pagure.io/fesco/issue/2020</a></p><blockquote><p>#2020 Firefox is switching from gcc to clang/llvm
Closed: Rejected a year ago</p></blockquote></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="thread-summary-1">Thread summary (1)</h1><blockquote><p>Mozilla <em>upstream switches from gcc to clang</em> and we're going to follow upstream
here due to clang performance, maintenance costs and compilation speed.</p></blockquote><p>(later)</p><blockquote><p>the <em>debuginfo</em> generated by it (clang) was pretty broken
(...)</p><p>clang/llvm doesn't generate <em>asynchronous unwind</em> tables on all architectures
(...)</p><p>currently testing if <tt>-fno-semantics-interposition</tt> (the default behavior of clang, but not of gcc) doesn't affect significantly the non-LTO builds</p></blockquote></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="thread-summary-2">Thread summary (2)</h1><blockquote><p>there are <em>security</em> issues (llvm doesn't implement e.g. <tt>-D_FORTIFY_SOURCE=2</tt> properly)</p><p>As for <em>security</em>, <tt>-fstack-protector*</tt> is another thing not properly implemented
in clang</p><p>must continue to compile using gcc in order to produce code less <em>vulnerable</em> to attack</p></blockquote></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="since-then-1">Since then... (1)</h1><p><a href="https://reviews.llvm.org/D71082">D71082</a>: Allow system header to provide their own implementation of some builtin [<em>landed</em>]</p><pre class="highlight code C++"><span class="n">__fortify_function</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">__NTH</span> <span class="p">(</span><span class="n">memcpy</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">__restrict</span> <span class="n">__dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__restrict</span> <span class="n">__src</span><span class="p">,</span>
         <span class="kt">size_t</span> <span class="n">__len</span><span class="p">))</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">__builtin___memcpy_chk</span> <span class="p">(</span><span class="n">__dest</span><span class="p">,</span> <span class="n">__src</span><span class="p">,</span> <span class="n">__len</span><span class="p">,</span> <span class="n">__bos0</span> <span class="p">(</span><span class="n">__dest</span><span class="p">));</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="since-then-2">Since then... (2)</h1><p><a href="https://reviews.llvm.org/D71566">D71566</a>: Improve static checks for <tt>sprintf</tt> and <tt>__builtin___sprintf_chk</tt> [<em>landed</em>]</p><pre class="highlight code c"><span class="kt">char</span><span class="o">*</span> <span class="nf">some</span><span class="p">(</span><span class="kt">double</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"% .2e"</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span></pre><pre class="highlight code">some.c:4:3: warning: 'sprintf' will   \
always overflow; destination buffer   \
has size 4, but format string expands \
to at least 9 [-Wfortify-source]</pre></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="since-then-3">Since then... (3)</h1><p><a href="https://reviews.llvm.org/D72829">D72829</a>: Implement <tt>-fsemantic-interposition</tt> [<em>accepted</em>]</p><pre class="highlight code c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;}</span>

<span class="kt">int</span> <span class="nf">bar</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;}</span>

<span class="kt">int</span> <span class="nf">foobar</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">foo</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="p">();</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="since-then-4">Since then... (4)</h1><p><a href="https://reviews.llvm.org/D68720">D68720</a>: Support <tt>-fstack-clash-protection</tt> for x86 <em>needs review</em></p><pre class="highlight code c"><span class="kt">void</span> <span class="nf">some</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">volatile</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">8000</span><span class="p">];</span>
    <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre><pre class="highlight code asm"><span class="nl">some:</span>
    <span class="nf">subq</span>    <span class="no">$4096</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="nf">movq</span>    <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
    <span class="nf">subq</span>    <span class="no">$3784</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="nf">movl</span>    <span class="nv">%esi</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="nf">movb</span>    <span class="no">$1</span><span class="p">,</span> <span class="p">-</span><span class="mi">128</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">,</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="nf">addq</span>    <span class="no">$7880</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="nf">retq</span></pre></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="is-that-all">Is that all?</h1><p>What about other +/- hidden <em>difference</em> between GCC and Clang?</p><p>We should try to <em>prevent</em> such surprises</p><p>What about taking a step ahead and <strong>recompile world</strong>?</p></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="acknowledgment">Acknowledgment</h1><p><em>the following relies a lot on Tom Stellar's work on the subject</em></p></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="requirements">Requirements</h1><p>Fedora has made the move to <strong>Python 3</strong></p><ul><li>Many LLVM tools use Python: <em>lldb</em>, <em>clang-format</em>...</li><li>No clear status on that subject within the LLVM community</li><li>Most script are currently <em>py2 and py3 compatible</em></li></ul></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="annobin">Annobin</h1><p>A <em>GCC plugin</em> that collects <em>hardening flags</em> and emits reports</p><ul><li>Relies on features not supported by <strong>lld</strong> (merging of notes in group sections) <a href="https://reviews.llvm.org/D56437">D56437</a>, <a href="https://reviews.llvm.org/D70146">D70146</a> [<em>both landed</em>]</li><li>Need to port to a clang plugin <em>WIP</em></li></ul></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="setup">Setup</h1><p>How to change the underlying compiler?</p><ul><li>update alternatives?</li><li>env variables (<tt>CC</tt>, <tt>CXX</tt>)?</li><li><em>patch RPM macros</em> (<tt>%__make</tt>, <tt>%__cc</tt>...)</li></ul><p>How to detect which compiler has been used?</p><ul><li><tt>grep</tt> logs?</li><li>elf inspection?</li><li>logging through a script?</li></ul></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="results-summary">Results Summary</h1><p>On Rawhide:</p><blockquote><p>TOTAL: 4303 PASS: 3016 FAIL: 1141 WARN: 0 SKIP: 146</p></blockquote></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="unsupported-flags">Unsupported Flags</h1><blockquote><p>unknown argument: '-fstack-clash-protection'</p><p>unknown argument: '-mvectorize-with-neon-quad'</p><p>unknown argument: '-maccumulate-outgoing-args'</p><p>unknown argument: '-fvar-tracking'</p><p>unknown argument: '-fno-trampolines'</p><p>unknown argument: '-fno-enforce-eh-specs'</p></blockquote></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="hooking-failed">Hooking failed</h1><blockquote><p>XXXX was not built with clang</p></blockquote></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="werror-hell"><tt>-Werror</tt> hell</h1><blockquote><p>'printf' macro redefined [-Werror,-Wmacro-redefined]</p><p>ignoring return value of function declared with 'warn_unused_result' attribute [-Werror,-Wunused-result]</p><p>all paths through this function will call itself [-Werror,-Winfinite-recursion]</p></blockquote></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="ffinite-math-only"><tt>-ffinite-math-only</tt></h1><blockquote><p>undefined reference to <tt>__.*_finite</tt></p></blockquote></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="configure-errors">Configure errors</h1><blockquote><p>ERROR: Compiler cc can not compile programs</p><p>configure: error: C compiler cannot create executables</p><p>configure: error: Some functions are not usable.</p><p>configure: error: libxml2 not found</p></blockquote></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="packaging-issues">Packaging issues</h1><blockquote><p>libclang_rt.asan-x86_64.a: No such file or directory</p><p>/usr/bin/ld: cannot find .*libclang_rt.profile-x86_64.a: No such file or directory</p><p>/usr/bin/ld: cannot find -lgcc_s</p></blockquote></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="disagreement-on-the-standard">Disagreement on the standard</h1><blockquote><p>error: use of undeclared identifier</p><p>error: ordered comparison between pointer and zero</p></blockquote></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="language-extensions">Language extensions</h1><blockquote><p>error: function definition is not allowed here</p></blockquote></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="openmp">OpenMP</h1><blockquote><p>OpenMP: error ... not supported by compiler</p><p>cannot find -lomp</p></blockquote></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><h1 id="packaging-genericity">Packaging genericity</h1><ul><li><tt>make</tt> instead of <tt>%{__make}</tt> <tt>%make_build</tt>,  <tt>%make_install</tt></li><li><tt>gcc</tt> instead of <tt>%{__cc}</tt></li><li><tt>g++</tt> instead of <tt>%{__cxx}</tt></li></ul></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><h1 id="conclusion">Conclusion</h1><p>Great opportunity to improve:</p><ul><li>packaging genericity</li><li>upstream genericity / quality / standard respect</li><li>clang internals</li><li>clang / gcc compatibility</li></ul><p>Bonus:</p><blockquote><p>error: no member named '__dprintf_chk'</p></blockquote></div></div><div id="slide-number" class="slide-number">
        1
      </div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
        document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
      </script></body></html>