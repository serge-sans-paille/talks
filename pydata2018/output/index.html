<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Crossing the native code frontier</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="font.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="150"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="crossing-the-native-code-frontier">Crossing the native code frontier</h1><p><em>Serge &#xAB; sans paille &#xBB; Guelton &lt;serge.guelton@telecom-bretagne.eu&gt;</em></p><p>PyParis 2018 -- France / 14 -- 15 november 2018</p><p><em>a talk from Namek, the ultimate frontier</em></p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="foreword">Foreword</h1><p>Whenever I'll be speaking of Python, I'm referencing:</p><blockquote><ul><li>the Python <strong>3</strong> language</li><li>its reference interpreter, <strong>CPython</strong></li></ul></blockquote></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="python-a-glue-language">Python, a glue language</h1><p>All theses modules are written in C:</p><ul><li>itertools</li><li>re</li><li>...</li></ul><p>And these ones relie on C extension:</p><ul><li>coverage</li><li>lxml</li><li>markupsafe</li><li>numpy</li><li>scipy</li><li>tornado</li><li>zmq</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="at-the-core-pyobject">At the core: <tt>PyObject</tt></h1><p>Every object in Python is represented as a pointer to a reference-counted,
heap-allocated structure, the <tt>PyObject*</tt>.</p><p>It wraps (among other things) an <em>actual value</em></p><pre class="highlight code">    ------------
    | PyObject* |
    -------------
    |  typeinfo |
    |  refcount |
    |    ...    |
    |   value   |
    -------------

RARE VIEW OF A PYOBJECT*</pre></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="example-pylist">Example: <tt>PyList</tt></h1><pre class="highlight code">             -----------
             | PyList* |
             -----------
             |   ...   |
             |   ptr   |
             -----------
                 |
                 |
-------------------------------------
| PyObject* | PyObject* | PyObject* |
-------------------------------------

     GUTS OF [1., "TWO", 3]</pre></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="consequences">Consequences</h1><ol><li>Great flexibility (dynamic typing, memory management etc)</li><li><dl><dt>Great costs</dt><dd><ul><li>boxing/unboxing</li><li>managed values (<tt>sizeof(PyObject) == 16</tt> on my laptop)</li><li>memory fragmentation</li></ul></dd></dl></li></ol></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="crossing-the-frontier">Crossing the Frontier</h1><p>Native code typically operate on unmanaged, unboxed value.</p><ul><li><dl><dt>First step when performing a native call is to unbox values</dt><dd><ol><li>It is <strong>tedious</strong></li><li>It is <strong>costly</strong></li><li>It requires <strong>care</strong></li></ol></dd></dl></li></ul></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="being-less-tedious">Being less Tedious</h1><ul><li><tt>ctypes</tt> for manual, explicit unboxing</li><li><a href="https://docs.python.org/3.6/c-api/">https://docs.python.org/3.6/c-api/</a> when explicit is better than implicit</li><li><tt>cffi</tt>, <tt>dragonffi</tt> or even <tt>cython</tt> when high-level is better than low-level</li><li><tt>pybind11</tt> for C++ devs</li><li><tt>swig</tt> for 20th century lover</li></ul></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="being-careful">Being Careful</h1><p>Updates on unboxed value may not modify the boxed value!</p><pre class="highlight code python"><span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></pre><p><tt>!=</tt></p><pre class="highlight code c"><span class="kt">void</span> <span class="nf">up</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">first</span> <span class="o">=</span> <span class="n">PyList_GetItem</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="being-less-costly">Being less Costly</h1><pre class="highlight code">...</pre></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="id1">Being less Costly</h1><h2 id="unchecked-conversion">Unchecked conversion</h2><pre class="highlight code C++"><span class="kt">long</span> <span class="nf">unbox</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// comment this test for more fun
</span>    <span class="k">if</span><span class="p">(</span><span class="n">PyLong_Check</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"..."</span><span class="p">);</span></pre></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="id2">Being less Costly</h1><h2 id="mixed-mode">Mixed mode</h2><ul><li>Only convert the objects whose unboxing is costly/frequent</li><li>Cython's speciality!</li></ul><h2 id="convert-scarcely">Convert scarcely</h2><ul><li>Avoid fine-grain interface, make sure heavy computations happen in a single function</li></ul></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="id3">Being less Costly</h1><h2 id="start-unboxed">Start unboxed</h2><ul><li>A Python List starts as boxed =&gt; high conversion cost <tt>O(n)</tt></li><li>A Numpy Array starts as unboxed =&gt; low conversion cost <tt>O(1)</tt></li></ul><p>This is a trade-off!</p></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="why">Why?</h1><p><em>Managed, fine grain operation on Numpy array are costly</em></p></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="id4">Why?</h1><p>Because that's just crossing the frontier, the other way around!</p></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="avoiding-conversion">Avoiding Conversion</h1><p>Use a <tt>PyCapsule</tt>!</p><pre class="highlight code C"><span class="n">PyObject</span><span class="o">*</span> <span class="nf">PyCapsule_New</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pointer</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">PyCapsule_Destructor</span> <span class="n">destructor</span><span class="p">);</span></pre><p>And live in the native world for ever</p><p><em>you indeed need a capsule to go to Namek</em></p></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="illustration-x2">Illustration x2</h1><pre class="highlight code python"><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="c1"># capsulefactory</span>
<span class="n">PyCapsule_New</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pythonapi</span><span class="o">.</span><span class="n">PyCapsule_New</span>
<span class="n">PyCapsule_New</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span>
<span class="n">PyCapsule_New</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span>
                          <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
                          <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
<span class="c1"># load libm</span>
<span class="n">libm</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s1">'/lib/.../libm.so.6'</span><span class="p">)</span>
<span class="c1"># extract the proper symbol</span>
<span class="n">cbrt</span> <span class="o">=</span> <span class="n">libm</span><span class="o">.</span><span class="n">cbrt</span>
<span class="c1"># wrap it</span>
<span class="n">capsule</span> <span class="o">=</span> <span class="n">PyCapsule_New</span><span class="p">(</span><span class="n">cbrt</span><span class="p">,</span>
                        <span class="s1">'double(double)'</span><span class="p">,</span>
                        <span class="bp">None</span><span class="p">)</span></pre></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="quizz-0">Quizz '0</h1><p>How many conversion happens?</p><pre class="highlight code python"><span class="c1">#pythran export quizz0(int)</span>
<span class="k">def</span> <span class="nf">quizz0</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">obj</span> <span class="o">+</span> <span class="mi">1</span></pre></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="quizz-1">Quizz '1</h1><p>How many conversion happens?</p><pre class="highlight code python"><span class="c1">#pythran export quizz1(int [])</span>
<span class="k">def</span> <span class="nf">quizz1</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span></pre></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="quizz-2">Quizz '2</h1><p>How many conversion happens?</p><pre class="highlight code python"><span class="c1">#pythran export quizz2(int list)</span>
<span class="k">def</span> <span class="nf">quizz2</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span></pre></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="quizz-3">Quizz '3</h1><p>Any issue there?</p><pre class="highlight code python"><span class="c1">#pythran export quizz3(int set)</span>
<span class="k">def</span> <span class="nf">quizz3</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="quizz-4">Quizz '4</h1><p>And there?</p><pre class="highlight code python"><span class="c1">#pythran export quizz4(float64[])</span>
<span class="k">def</span> <span class="nf">quizz4</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span></pre></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="quizz-5">Quizz '5</h1><p>How many conversion happen here?</p><pre class="highlight code python"><span class="c1">#pythran export quizz5(float64(int32), int32)</span>
<span class="k">def</span> <span class="nf">quizz5</span><span class="p">(</span><span class="n">capsule</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">capsule</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span></pre></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="ending-words">Ending words</h1><p>Now you should be able to understand</p><ul><li>Some Numpy performance behavior</li><li>Why it's challenging to write a JIT like PyPy</li><li>The core idea behind Cython</li></ul><p>And if you don't, it's time for questions :-)</p></div></div><div id="slide-number" class="slide-number">
        1
      </div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript">
        document.getElementById("impress").addEventListener("impress:stepenter", update_slide_number, false);
      </script></body></html>